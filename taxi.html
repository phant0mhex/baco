<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Taxis</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>
<body class="h-full bg-gray-50">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Sociétés de taxi par lieu</h1>

    <div class="mb-6 flex justify-end">
      <button onclick="showTaxiModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un taxi</span>
      </button>
    </div>

    <div class="flex flex-wrap gap-3 mb-8" id="lieuCheckboxes">
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Charleroi" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Charleroi</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Mons" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Mons</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Namur" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Namur</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Enghien" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Enghien</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Lessines" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Lessines</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Tournai" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Tournai</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Ath" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Ath</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Arlon" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Arlon</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Braine Le Comte" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Braine Le Comte</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Bruxelles" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Bruxelles</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Dinant" onchange="updateTaxiDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Dinant</span>
      </label>
    </div>

    <hr class="my-8">

    <div class="content" id="content">
      <p class="text-gray-600">Veuillez sélectionner un lieu pour voir les taxis.</p>
    </div>
  </div>


  <script src="js/layout.js" defer></script>
  
<script>
    // --- FONCTION PRINCIPALE (CORRIGÉE) ---

    async function updateTaxiDisplay() {
      const lieuxSelectionnes = Array.from(document.querySelectorAll('#lieuCheckboxes input:checked'))
        .map(cb => cb.value);

      const container = document.getElementById('content');

      if (lieuxSelectionnes.length === 0) {
        container.innerHTML = '<p class="text-gray-600">Veuillez sélectionner un lieu pour voir les taxis.</p>';
        return;
      }

      container.innerHTML = '<p class="text-gray-600">Chargement...</p>';
      
      const { data: taxisAffiches, error } = await supabaseClient
        .from('taxis')
        .select('id, nom, lieux, contacts, mail, adresse, remarques')
        .overlaps('lieux', lieuxSelectionnes);

      if (error) {
        container.innerHTML = `<p class='text-red-600'>Erreur: ${error.message}</p>`;
        return;
      }
      
      if (taxisAffiches.length === 0) {
        container.innerHTML = '<p class="text-gray-600">Aucune société trouvée pour les lieux sélectionnés.</p>';
        return;
      }

      // --- CORRECTION : Génération du HTML complet ---
      container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">' +
        taxisAffiches.map(taxi => {
          
          const taxiJson = JSON.stringify(taxi).replace(/"/g, "&quot;");

          // 1. Lieux (Tags)
          const lieuxHtml = taxi.lieux.map(lieu =>
            `<span class="px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-700 text-sm font-medium">${lieu}</span>`
          ).join('');

          // 2. Contacts (Téléphones) - HTML COMPLET
          const contactsHtml = (taxi.contacts.length === 0 || taxi.contacts[0] === 'nihil') ? '' :
            taxi.contacts.map(num =>
            `<a href="etrali:${num}" class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
               <i data-lucide="phone" class="w-4 h-4 text-blue-700 flex-shrink-0"></i>
               <span class="font-mono text-sm font-medium text-blue-800">${num}</span>
             </a>`
            ).join('');

          // 3. Mails - HTML COMPLET
          const mailsHtml = (taxi.mail.length === 0 || taxi.mail[0] === 'nihil') ? '' :
            taxi.mail.map(email =>
              `<a href="mailto:${email}" class="flex items-center gap-3 p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
                 <i data-lucide="mail" class="w-4 h-4 text-gray-600 flex-shrink-0"></i>
                 <span class="text-sm font-medium text-gray-800 break-all">${email}</span>
               </a>`
            ).join('');

          // 4. Adresse - HTML COMPLET
          const adresseHtml = (taxi.adresse.length === 0 || taxi.adresse[0] === 'nihil') ? '' :
            taxi.adresse.map(adr =>
              `<div class="flex items-start gap-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                 <i data-lucide="map-pin" class="w-4 h-4 text-gray-600 flex-shrink-0 mt-0.5"></i>
                 <span class="text-sm font-medium text-gray-800">${adr}</span>
               </div>`
            ).join('');
          
          // 5. Remarques - HTML COMPLET
          const remarquesHtml = (taxi.remarques.length === 0 || taxi.remarques[0] === 'nihil') ? '' :
            '<div class="border-t pt-4 mt-4">' +
            taxi.remarques.map(rem =>
              `<div class="flex items-start gap-2.5 text-sm p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                 <i data-lucide="info" class="w-4 h-4 text-yellow-700 flex-shrink-0 mt-0.5"></i>
                 <span class="text-yellow-900">${rem}</span>
               </div>`
            ).join('') + '</div>';

          // --- Assemblage de la Carte ---
          return `<div class="bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col">
                    
                    <div class="p-5 flex-grow">
                      <h3 class="text-xl font-semibold text-gray-900 flex items-center gap-2.5">
                        <i data-lucide="taxi" class="w-5 h-5 text-blue-600"></i>
                        <span>${taxi.nom}</span>
                      </h3>
                      
                      <div class="flex flex-wrap gap-2 border-t pt-4 mt-4">
                        ${lieuxHtml}
                      </div>

                      <div class="flex flex-col gap-3 mt-4">
                        ${contactsHtml}
                        ${mailsHtml}
                        ${adresseHtml}
                      </div>
                      
                      ${remarquesHtml}
                    </div>

                    <div class="p-3 bg-gray-50 border-t flex justify-end gap-2">
                      <button onclick='showTaxiModal(${taxiJson})' class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-blue-600 bg-blue-100 rounded hover:bg-blue-200">
                        <i data-lucide="pencil" class="w-3 h-3"></i> Modifier
                      </button>
                      <button onclick="deleteTaxi(${taxi.id}, '${taxi.nom}')" class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded hover:bg-red-200">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Supprimer
                      </button>
                    </div>
                    
                  </div>`;
        }).join('') +
        '</div>';

      lucide.createIcons();
    }
    
    // --- FONCTIONS D'ÉDITION (INCHANGÉES) ---

    const modal = document.getElementById('taxi-modal');
    const modalTitle = document.getElementById('modal-title');
    const taxiForm = document.getElementById('taxi-form');
    const taxiIdInput = document.getElementById('modal-taxi-id');
    
    function showTaxiModal(taxi = null) {
      const isEdit = taxi !== null;
      taxiForm.reset();
      const joinIfNotEmpty = (arr) => (arr && arr.length > 0 && arr[0] !== 'nihil') ? arr.join(', ') : '';
      
      if (isEdit) {
        modalTitle.textContent = 'Modifier le taxi';
        taxiIdInput.value = taxi.id;
        document.getElementById('modal-nom').value = taxi.nom;
        document.getElementById('modal-lieux').value = joinIfNotEmpty(taxi.lieux);
        document.getElementById('modal-contacts').value = joinIfNotEmpty(taxi.contacts);
        document.getElementById('modal-mail').value = joinIfNotEmpty(taxi.mail);
        document.getElementById('modal-adresse').value = joinIfNotEmpty(taxi.adresse);
        document.getElementById('modal-remarques').value = joinIfNotEmpty(taxi.remarques);
      } else {
        modalTitle.textContent = 'Ajouter un taxi';
        taxiIdInput.value = '';
      }
      modal.style.display = 'flex';
      lucide.createIcons();
    }

    function hideTaxiModal() {
      modal.style.display = 'none';
    }

    async function handleTaxiFormSubmit(event) {
      event.preventDefault();
      
      const taxiId = taxiIdInput.value;
      const isEdit = taxiId !== '';
      
      const splitAndClean = (str) => {
        const arr = str.split(',').map(s => s.trim()).filter(Boolean);
        return arr.length > 0 ? arr : ['nihil']; // Assure de ne pas envoyer un array vide
      };

      // CORRECTION : S'assurer que 'nihil' n'est envoyé que si le champ est vide
      const cleanNom = document.getElementById('modal-nom').value;
      const cleanLieux = splitAndClean(document.getElementById('modal-lieux').value);
      const cleanContacts = splitAndClean(document.getElementById('modal-contacts').value);
      const cleanMail = splitAndClean(document.getElementById('modal-mail').value);
      const cleanAdresse = splitAndClean(document.getElementById('modal-adresse').value);
      const cleanRemarques = splitAndClean(document.getElementById('modal-remarques').value);

      const taxiData = {
        nom: cleanNom,
        lieux: cleanLieux.length > 0 ? cleanLieux : ['nihil'],
        contacts: cleanContacts.length > 0 ? cleanContacts : ['nihil'],
        mail: cleanMail.length > 0 ? cleanMail : ['nihil'],
        adresse: cleanAdresse.length > 0 ? cleanAdresse : ['nihil'],
        remarques: cleanRemarques.length > 0 ? cleanRemarques : ['nihil']
      };

      let error;
      const submitButton = document.getElementById('modal-submit-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Enregistrement...';

      if (isEdit) {
        const { error: updateError } = await supabaseClient
          .from('taxis')
          .update(taxiData)
          .eq('id', taxiId);
        error = updateError;
      } else {
        const { error: insertError } = await supabaseClient
          .from('taxis')
          .insert([taxiData]);
        error = insertError;
      }

      submitButton.disabled = false;
      submitButton.textContent = 'Enregistrer';

      if (error) {
        alert("Erreur lors de l'opération: " + error.message);
      } else {
        alert(isEdit ? "Taxi mis à jour !" : "Taxi ajouté !");
        hideTaxiModal();
        updateTaxiDisplay(); // Rafraîchir la liste
      }
    }

    async function deleteTaxi(id, nom) {
      if (!confirm(`Êtes-vous sûr de vouloir supprimer le taxi "${nom}" ?`)) {
        return;
      }
      const { error } = await supabaseClient
        .from('taxis')
        .delete()
        .eq('id', id);
      if (error) {
        alert("Erreur lors de la suppression: " + error.message);
      } else {
        alert("Taxi supprimé avec succès !");
        updateTaxiDisplay();
      }
    }
  </script>

  <div id="taxi-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un taxi</h3>
      <button onclick="hideTaxiModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <form id="taxi-form" onsubmit="handleTaxiFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto">
        <input type="hidden" id="modal-taxi-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-lieux" class="block text-sm font-medium text-gray-700">Lieux (séparés par virgule)</label>
          <input type="text" id="modal-lieux" placeholder="Mons, Charleroi, Ath..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="md:col-span-2">
          <label for="modal-contacts" class="block text-sm font-medium text-gray-700">Téléphones (séparés par virgule)</label>
          <input type="text" id="modal-contacts" placeholder="0495/xx.xx.xx, 0800/xx.xxx..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="md:col-span-2">
          <label for="modal-mail" class="block text-sm font-medium text-gray-700">Emails (séparés par virgule)</label>
          <input type="text" id="modal-mail" placeholder="contact@taxi.be..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="md:col-span-2">
          <label for="modal-adresse" class="block text-sm font-medium text-gray-700">Adresse (séparés par virgule si plusieurs)</label>
          <input type="text" id="modal-adresse" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="md:col-span-2">
          <label for="modal-remarques" class="block text-sm font-medium text-gray-700">Remarques (séparés par virgule)</label>
          <textarea id="modal-remarques" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideTaxiModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>
</body>
</html>