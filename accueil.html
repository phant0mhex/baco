<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-100 dark:bg-gray-800">
<head>
  <meta charset="UTF-8">
  <title>Accueil - Portail BACO</title>
  <link rel="icon" type="image/png" href="favicon.jpg">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">
<script src="https://unpkg.com/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/lucide@0.303.0/dist/umd/lucide.min.js" defer></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
          animation: {
            'gradient-pan': 'gradient-pan 3s ease infinite',
          },
          keyframes: {
            'gradient-pan': {
              '0%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
              '100%': { backgroundPosition: '0% 50%' },
            }
          }
        },
      },
    }
  </script>
</head>
<body class="flex flex-col min-h-screen">

  <div id="nav-placeholder"></div>

<div class="flex-grow"> 
  <div class="container mx-auto p-8">
    <header class="mb-10 text-center">
      
      <h2 id="user-greeting" 
          class="text-2xl font-bold mb-4 
                 bg-gradient-to-r from-blue-600 to-cyan-400 
                 dark:from-blue-400 dark:to-cyan-300 
                 bg-clip-text text-transparent 
                 bg-[size:200%_auto] animate-gradient-pan" 
          style="min-height: 2rem;">
      </h2>
      
      <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">Bienvenue sur le portail de données</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">Choisissez votre domaine :</p>
    </header>


  <div id="pmr-widget-container" class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center gap-2">
        <i data-lucide="activity" class="w-6 h-6 text-red-500"></i>
        <span>Problèmes en cours (Rampes PMR)</span>
      </h2>
      <div id="pmr-issues-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </div>


  <!--   <div id="favorites-container" class="mb-12" style="display: none;">
      <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Mes Favoris</h2>
      <div id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        </div>
    </div> -->

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

           
      <a href="operationnel.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
        <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
          <i data-lucide="shield" class="w-5 h-5 text-blue-600"></i>
          <span>Opérationnel</span>
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Informations sur les sites et numéros d'urgence.</p>
      </a>

      <a href="pmr.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="accessibility" class="w-5 h-5 text-blue-600"></i>
           <span>Rampes PMR</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Données relatives aux Personnes à Mobilité Réduite.</p>
      </a>
      
      <a href="clients_pmr.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
           <span>Clients PMR</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire des clients à mobilité réduite.</p>
      </a>
      
      <a href="bus.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="bus" class="w-5 h-5 text-blue-600"></i>
           <span>Bus</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Filtrage des chauffeurs par société et par ligne.</p>
      </a>

      <a href="taxi.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="car" class="w-5 h-5 text-blue-600"></i>
           <span>Taxi</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Filtrage des sociétés de taxi par lieu d'intervention.</p>
      </a>
      
      <a href="repertoire.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="book-user" class="w-5 h-5 text-blue-600"></i>
           <span>Répertoire</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire téléphonique interne (MIA, RCC, OCC).</p>
      </a>

      <a href="lignes.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="train" class="w-5 h-5 text-blue-600"></i>
           <span>Lignes</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Détails des lignes, adresses PN et zones SPI.</p>
      </a>
      
      <a href="documents.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="folder" class="w-5 h-5 text-blue-600"></i>
           <span>Documents</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Procédures d'urgence, schémas, etc.</p>
      </a>
      
      <a href="ptcar.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="tag" class="w-5 h-5 text-blue-600"></i>
           <span>PtCar</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire des abréviations PtCar.</p>
      </a>

    </div>
  </div>
</div> 

  <script src="js/layout.js" defer></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {


// ==========================================================
      // == NOUVELLE FONCTION POUR LE WIDGET PMR
      // ==========================================================
      async function loadPmrIssuesWidget() {
        const listContainer = document.getElementById('pmr-issues-list');
        if (!listContainer) return;

        // 1. Définir l'état de chargement
        listContainer.innerHTML = `
          <div class="col-span-full flex items-center justify-center p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg">
            <i data-lucide="loader-2" class="w-6 h-6 text-blue-500 animate-spin"></i>
            <span class="ml-3 text-gray-600 dark:text-gray-400">Chargement des problèmes en cours...</span>
          </div>`;
        lucide.createIcons();

        try {
          // 2. Interroger Supabase pour les rampes 'HS' ou 'En attente'
          const { data, error } = await supabaseClient
            .from('pmr_data')
            .select('gare, quai, etat_rampe, rampe_id')
            .in('etat_rampe', ['HS', 'En attente']) // Le filtre clé
            .order('gare', { ascending: true });

          if (error) throw error;

          // 3. Gérer le cas où il n'y a aucun problème
          if (data.length === 0) {
            listContainer.innerHTML = `
              <div class="col-span-full flex items-center justify-center p-6 bg-white dark:bg-gray-900 border border-green-200 dark:border-green-700 rounded-lg">
                <i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i>
                <span class="ml-3 text-gray-700 dark:text-gray-200">Aucun problème signalé sur les rampes (HS ou En attente).</span>
              </div>`;
          } else {
            // 4. Afficher les problèmes trouvés
            listContainer.innerHTML = data.map(issue => {
              let etatColor = 'text-gray-600 bg-gray-100 dark:text-gray-300 dark:bg-gray-700'; // En attente
              if (issue.etat_rampe === 'HS') {
                etatColor = 'text-red-800 bg-red-100 dark:text-red-200 dark:bg-red-900';
              }
              
              // Crée un lien vers pmr.html avec un paramètre de recherche
              return `
                <a href="pmr.html?search=${issue.rampe_id || issue.gare}" 
                   title="Voir les détails dans la section PMR"
                   class="block p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
                  <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-400">${issue.gare}</h4>
                    <span class="px-2.5 py-0.5 text-xs font-bold rounded-full ${etatColor}">
                      ${issue.etat_rampe}
                    </span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i data-lucide="map-pin" class="w-3 h-3 inline-block mr-1"></i>
                    Quai: <strong>${issue.quai || 'N/A'}</strong>
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i data-lucide="hash" class="w-3 h-3 inline-block mr-1"></i>
                    ID: <strong>${issue.rampe_id || 'N/A'}</strong>
                  </p>
                </a>`;
            }).join('');
          }
          lucide.createIcons();

        } catch (error) {
          // 5. Gérer les erreurs
          console.error("Erreur chargement widget PMR:", error.message);
          listContainer.innerHTML = `
            <div class="col-span-full flex items-center justify-center p-6 bg-white dark:bg-gray-900 border border-red-200 dark:border-red-700 rounded-lg">
              <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
              <span class="ml-3 text-red-700 dark:text-red-200">Erreur: ${error.message}</span>
            </div>`;
        }
        lucide.createIcons();
      }

      lucide.createIcons();
      let currentUserId = null;
      
      async function loadUserGreeting() {
        const greetingElement = document.getElementById('user-greeting');
        if (!greetingElement) return;
        try {
          const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
          if (authError || !user) throw authError || new Error('Utilisateur non connecté');
          
          currentUserId = user.id;
          
          const { data, error } = await supabaseClient.from('profiles').select('full_name').eq('id', user.id).single();
          if (error) throw error;
          if (data && data.full_name) {
            greetingElement.textContent = `Bonjour, ${data.full_name}`;
          } else {
            greetingElement.textContent = `Bonjour !`;
          }
        } catch (error) {
          console.error("Erreur chargement salut :", error.message);
          greetingElement.textContent = 'Bonjour !';
        }
      }
      
      
    



    });
  </script>
<div id="footer-placeholder"></div>
</body>
</html>