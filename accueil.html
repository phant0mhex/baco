<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-100 dark:bg-gray-800">
<head>
  <meta charset="UTF-8">
  <title>Accueil - Portail BACO</title>
  <link rel="icon" type="image/png" href="favicon.jpg">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">
<script src="https://unpkg.com/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/lucide@0.303.0/dist/umd/lucide.min.js" defer></script>
<link rel="stylesheet" href="https://unpkg.com/notyf@3/notyf.min.css">
  <script src="https://unpkg.com/notyf@3/notyf.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
          animation: {
            'gradient-pan': 'gradient-pan 3s ease infinite',
          },
          keyframes: {
            'gradient-pan': {
              '0%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
              '100%': { backgroundPosition: '0% 50%' },
            }
          }
        },
      },
    }
  </script>
  <style>
  /* Cacher le corps par défaut jusqu'à ce que l'auth soit vérifiée */
  body {
    visibility: hidden;
  }
</style>
</head>
<body class="flex flex-col min-h-screen">

  <div id="nav-placeholder"></div>

<div class="flex-grow"> 
  <div class="container mx-auto p-8">
    <header class="mb-10 text-center">
      
      <h2 id="user-greeting" 
          class="text-2xl font-bold mb-4 
                 bg-gradient-to-r from-blue-600 to-cyan-400 
                 dark:from-blue-400 dark:to-cyan-300 
                 bg-clip-text text-transparent 
                 bg-[size:200%_auto] animate-gradient-pan" 
          style="min-height: 2rem;">
      </h2>
      
      <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">Bienvenue sur le portail de données</h1>
      <p class="text-lg text-gray-600 dark:text-gray-400">Choisissez votre domaine :</p>
    </header>


  <div id="pmr-widget-container" class="mb-10">


     <button 
        type="button" 
        id="pmr-widget-toggle" 
        class="w-full text-left text-2xl font-semibold text-gray-800 dark:text-gray-100 flex items-center justify-between gap-2 p-2 rounded-lg transition-colors hover:bg-gray-200 dark:hover:bg-gray-700"
        title="Afficher/Masquer les problèmes en cours"
      >
        <span class="flex items-center gap-2">
          <i data-lucide="activity" class="w-6 h-6 text-red-500"></i>
          <span>Problèmes en cours (Rampes PMR)</span>
        </span>
        <i id="pmr-widget-chevron" data-lucide="chevron-up" class="w-6 h-6 text-gray-500 dark:text-gray-400"></i>
      </button>
      
      <div id="pmr-issues-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
        </div>
   
   
   
      </div>


<div id="journal-widget-container" class="mb-10">
      <button 
        type="button" 
        id="journal-widget-toggle" 
        class="w-full text-left text-2xl font-semibold text-gray-800 dark:text-gray-100 flex items-center justify-between gap-2 p-2 rounded-lg transition-colors hover:bg-gray-200 dark:hover:bg-gray-700"
        title="Afficher/Masquer l'activité récente"
      >
        <span class="flex items-center gap-2">
          <i data-lucide="book-copy" class="w-6 h-6 text-yellow-600"></i>
          <span>Activité Récente du Journal</span>
        </span>
        <i id="journal-widget-chevron" data-lucide="chevron-up" class="w-6 h-6 text-gray-500 dark:text-gray-400"></i>
      </button>
      <div id="journal-recent-list" class="space-y-4 mt-4">
        <a href="journal.html" class="block text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline text-center pt-2">
          Voir tout le journal
        </a>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

           
      <a href="operationnel.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
        <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
          <i data-lucide="shield" class="w-5 h-5 text-blue-600"></i>
          <span>Opérationnel</span>
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Informations sur les sites et numéros d'urgence.</p>
      </a>

      <a href="pmr.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="accessibility" class="w-5 h-5 text-blue-600"></i>
           <span>Rampes PMR</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Données relatives aux Personnes à Mobilité Réduite.</p>
      </a>
      
      <a href="clients_pmr.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
           <span>Clients PMR</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire des clients à mobilité réduite.</p>
      </a>
      
      <a href="bus.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="bus" class="w-5 h-5 text-blue-600"></i>
           <span>Bus</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Filtrage des chauffeurs par société et par ligne.</p>
      </a>

      <a href="taxi.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="car" class="w-5 h-5 text-blue-600"></i>
           <span>Taxi</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Filtrage des sociétés de taxi par lieu d'intervention.</p>
      </a>
      
      <a href="repertoire.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="book-user" class="w-5 h-5 text-blue-600"></i>
           <span>Répertoire</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire téléphonique interne (MIA, RCC, OCC).</p>
      </a>

      <a href="lignes.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="train" class="w-5 h-5 text-blue-600"></i>
           <span>Lignes</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Détails des lignes, adresses PN et zones SPI.</p>
      </a>
      
      <a href="documents.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="folder" class="w-5 h-5 text-blue-600"></i>
           <span>Documents</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Procédures d'urgence, schémas, etc.</p>
      </a>
      
      <a href="ptcar.html" class="block h-full p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
         <h3 class="flex items-center gap-3 text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
           <i data-lucide="tag" class="w-5 h-5 text-blue-600"></i>
           <span>PtCar</span>
         </h3>
         <p class="text-sm text-gray-600 dark:text-gray-400 pl-8">Répertoire des abréviations PtCar.</p>
      </a>

    </div>
  </div>
</div> 

<script src="js/core/layout.js" type="module"></script>
  
  <script>
    window.pageInit = () => {



      
      lucide.createIcons();
      let currentUserId = null;
      
      async function loadUserGreeting() {
        const greetingElement = document.getElementById('user-greeting');
        if (!greetingElement) return;
        try {
          const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
          if (authError || !user) throw authError || new Error('Utilisateur non connecté');
          
          currentUserId = user.id;
          
          const { data, error } = await supabaseClient.from('profiles').select('full_name').eq('id', user.id).single();
          if (error) throw error;
          if (data && data.full_name) {
            greetingElement.textContent = `Bonjour, ${data.full_name}`;
          } else {
            greetingElement.textContent = `Bonjour !`;
          }
        } catch (error) {
          console.error("Erreur chargement salut :", error.message);
          greetingElement.textContent = 'Bonjour !';
        }
      }
      

    // === FONCTION 3: JOURNAL RÉCENT ===
      function formatLogDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR', {
          day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
        }).replace('.', '');
      }

      async function loadRecentJournal() {
        const listContainer = document.getElementById('journal-recent-list');
        if (!listContainer) return;

        // Note: On ne met pas de spinner ici, car le widget peut être fermé
        try {
          const { data, error } = await supabaseClient
            .from('main_courante').select(`*, profiles ( full_name, avatar_url )`)
            .order('created_at', { ascending: false }).limit(3);
          if (error) throw error;
          
          let contentHtml = '';
          if (data.length === 0) {
            contentHtml = `<p class="text-sm text-gray-500 dark:text-gray-400 text-center p-4">Le journal est vide.</p>`;
          } else {
            contentHtml = data.map(entry => {
              const author = entry.profiles;
              const timestamp = formatLogDate(entry.created_at);
              const authorName = author ? author.full_name : 'Utilisateur supprimé';
              const authorAvatar = author ? author.avatar_url : 'https://via.placeholder.com/40';
              return `
                <div class="bg-white dark:bg-gray-900 shadow border border-gray-200 dark:border-gray-700 rounded-lg flex gap-4 p-4 mx-4">
                  <img src="${authorAvatar}" alt="avatar" class="w-10 h-10 rounded-full object-cover hidden sm:block">
                  <div class="flex-1">
                    <div class="flex justify-between items-center mb-2">
                      <div class="flex items-center gap-2">
                        <img src="${authorAvatar}" alt="avatar" class="w-8 h-8 rounded-full object-cover sm:hidden">
                        <span class="font-semibold text-gray-900 dark:text-gray-100">${authorName}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${timestamp}</span>
                      </div>
                    </div>
                    <p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${entry.message_content}</p>
                  </div>
                </div>`;
            }).join('<div class="my-4"></div>'); // Ajoute un espace entre les entrées
          }
          // On insère le contenu avant le lien "Voir tout"
          listContainer.insertAdjacentHTML('afterbegin', contentHtml);
          lucide.createIcons();
        } catch (error) {
          listContainer.insertAdjacentHTML('afterbegin', `<p class="text-red-500 p-4 mx-4">Erreur: ${error.message}</p>`);
        }
      }
      
   // ==========================================================
      // == SECTION WIDGET PMR COLLAPSIBLE
      // ==========================================================
      
      const pmrToggleBtn = document.getElementById('pmr-widget-toggle');
      const pmrContent = document.getElementById('pmr-issues-list');
      const pmrChevron = document.getElementById('pmr-widget-chevron');
      const pmrWidgetStateKey = 'bacoPmrWidgetState'; // Clé pour localStorage

      // 1. Appliquer l'état sauvegardé au chargement de la page
      // Par défaut (s'il n'y a rien), le widget est ouvert ('open')
      let isPmrOpen = localStorage.getItem(pmrWidgetStateKey) ? (localStorage.getItem(pmrWidgetStateKey) === 'open') : true;

      // 2. Fonction pour mettre à jour l'UI (icône et visibilité)
      function updatePmrWidgetVisuals() {
        if (isPmrOpen) {
          pmrContent.classList.remove('hidden');
          pmrChevron.setAttribute('data-lucide', 'chevron-up');
        } else {
          pmrContent.classList.add('hidden');
          pmrChevron.setAttribute('data-lucide', 'chevron-down');
        }
        lucide.createIcons(); // Redessiner l'icône modifiée
      }

      // 3. Appliquer l'état visuel initial
      updatePmrWidgetVisuals();

      // 4. Ajouter l'écouteur d'événement sur le bouton
      if (pmrToggleBtn) {
        pmrToggleBtn.addEventListener('click', () => {
          isPmrOpen = !isPmrOpen; // Inverser l'état
          localStorage.setItem(pmrWidgetStateKey, isPmrOpen ? 'open' : 'closed'); // Sauvegarder
          updatePmrWidgetVisuals(); // Mettre à jour l'UI
        });
      }
      
    // === FONCTION 4: WIDGET PMR ===
      async function loadPmrIssuesWidget() {
        const listContainer = document.getElementById('pmr-issues-list');
        if (!listContainer) return;
        try {
          const { data, error } = await supabaseClient
            .from('pmr_data').select('gare, quai, etat_rampe, rampe_id')
            .in('etat_rampe', ['HS', 'En attente']).order('gare', { ascending: true });
          if (error) throw error;
          
          if (data.length === 0) {
            listContainer.innerHTML = `
              <div class="col-span-full flex items-center justify-center p-6 bg-white dark:bg-gray-900 border border-green-200 dark:border-green-700 rounded-lg">
                <i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i>
                <span class="ml-3 text-gray-700 dark:text-gray-200">Aucun problème signalé sur les rampes.</span>
              </div>`;
          } else {
            listContainer.innerHTML = data.map(issue => {
              let etatColor = issue.etat_rampe === 'HS' ? 'text-red-800 bg-red-100 dark:text-red-200 dark:bg-red-900' : 'text-gray-600 bg-gray-100 dark:text-gray-300 dark:bg-gray-700';
              return `
                <a href="pmr.html?search=${issue.rampe_id || issue.gare}" 
                   title="Voir les détails"
                   class="block p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm hover:border-blue-500 hover:shadow-md transition-all">
                  <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-lg text-blue-700 dark:text-blue-400">${issue.gare}</h4>
                    <span class="px-2.5 py-0.5 text-xs font-bold rounded-full ${etatColor}">${issue.etat_rampe}</span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i data-lucide="map-pin" class="w-3 h-3 inline-block mr-1"></i>
                    Quai: <strong>${issue.quai || 'N/A'}</strong>
                  </p>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    <i data-lucide="hash" class="w-3 h-3 inline-block mr-1"></i>
                    ID: <strong>${issue.rampe_id || 'N/A'}</strong>
                  </p>
                </a>`;
            }).join('');
          }
          lucide.createIcons();
        } catch (error) {
          console.error("Erreur chargement widget PMR:", error.message);
          listContainer.innerHTML = `<p class="col-span-full text-red-500">Erreur chargement widget PMR.</p>`;
        }
      }
      

// ==========================================================
      // == FONCTION CORRIGÉE POUR LE WIDGET FAVORIS
      // ==========================================================
      async function loadFavoritesWidget() {
        const listContainer = document.getElementById('favorites-list');
        if (!listContainer) return;

        // 1. État de chargement
        listContainer.innerHTML = `
          <div class="col-span-full flex items-center justify-center p-6 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg">
            <i data-lucide="loader-2" class="w-6 h-6 text-blue-500 animate-spin"></i>
            <span class="ml-3 text-gray-600 dark:text-gray-400">Chargement des favoris...</span>
          </div>`;
        lucide.createIcons();

        if (!currentUserId) {
            await loadUserGreeting();
            if (!currentUserId) {
                listContainer.innerHTML = `<p class="text-red-500">Erreur: ID utilisateur non trouvé.</p>`;
                return;
            }
        }

        try {
          // 2. Appel de la fonction RPC (inchangé)
          const { data, error } = await supabaseClient.rpc('get_my_favorites');

          if (error) throw error;
          
          if (data.length === 0) {
            if (typeof checkIfFavoritesEmpty === 'function') {
                checkIfFavoritesEmpty();
            } else {
                listContainer.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 col-span-full text-center">Vous n'avez pas encore de favoris.</p>`;
            }
            return;
          }

          // 3. Afficher les favoris trouvés (AVEC LES BONS NOMS DE COLONNES)
          listContainer.innerHTML = data.map(fav => {
            switch (fav.type_contenu) {
              case 'client_pmr':
                // CORRECTION : Utiliser fav.client_prenom et fav.client_nom
                if (!fav.client_nom) return ''; // Au cas où le client a été supprimé
                return renderFavCard({
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'accessibility',
                  iconColor: 'text-blue-500',
                  title: `${fav.client_prenom || ''} ${fav.client_nom}`,
                  subtext: fav.client_tel,
                  link: `clients_pmr.html`
                });
              
              case 'taxi':
                // CORRECTION : Utiliser fav.taxi_nom et fav.taxi_contacts
                if (!fav.taxi_nom) return '';
                return renderFavCard({
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'car',
                  iconColor: 'text-yellow-500',
                  title: fav.taxi_nom,
                  subtext: (fav.taxi_contacts && fav.taxi_contacts.length > 0) ? fav.taxi_contacts[0] : 'N/A', 
                  link: `taxi.html`
                });
              
              case 'repertoire':
                // CORRECTION : Utiliser fav.contact_nom, etc.
                if (!fav.contact_nom) return '';
                return renderFavCard({
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'contact',
                  iconColor: 'text-green-500',
                  title: fav.contact_nom,
                  subtext: fav.contact_tel || fav.contact_groupe,
                  link: `repertoire.html`
                });
              
              case 'bus':
                 // CORRECTION : Utiliser fav.bus_societe_nom
                 if (!fav.bus_societe_nom) return '';
                 return renderFavCard({
                 // --- DÉBUT DU CODE RESTAURÉ ---
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'bus',
                  iconColor: 'text-purple-500',
                  title: fav.bus_societe_nom,
                  subtext: 'Société de bus',
                  link: `bus.html`
                  // --- FIN DU CODE RESTAURÉ ---
                });

              // NOUVEAU : Gérer les contacts/chauffeurs de bus
              case 'bus_contact':
                 if (!fav.bus_contact_nom) return '';
                 return renderFavCard({
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'user-check',
                  iconColor: 'text-purple-500',
                  title: fav.bus_contact_nom,
                  subtext: fav.bus_contact_tel,
                  link: `bus.html`
                });
              case 'bus_chauffeur':
                 if (!fav.bus_chauffeur_nom) return '';
                 return renderFavCard({
                  id: fav.id_contenu,
                  type: fav.type_contenu,
                  icon: 'user',
                  iconColor: 'text-purple-500',
                  title: fav.bus_chauffeur_nom,
                  subtext: fav.bus_chauffeur_tel,
                  link: `bus.html`
                });

              default:
                return '';
            }
          }).join('');
          
          lucide.createIcons();

        } catch (error) {
          console.error("Erreur chargement widget favoris:", error.message);
          listContainer.innerHTML = `<p class="col-span-full text-red-600">Erreur: ${error.message}</p>`;
        }
      }
      

      /**
       * (Fonction utilitaire) Génère le HTML pour une carte de favori
       */
      function renderFavCard({ id, type, icon, iconColor, title, subtext, link }) {
        return `
          <div class="favorite-card flex items-center justify-between p-4 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm">
            <a href="${link}" class="flex items-center gap-3 overflow-hidden" title="Voir le détail">
              <i data-lucide="${icon}" class="w-5 h-5 ${iconColor} flex-shrink-0"></i>
              <div class="overflow-hidden">
                <p class="font-semibold text-gray-800 dark:text-gray-100 truncate">${title}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${subtext || ''}</p>
              </div>
            </a>
            <button 
              onclick="window.toggleFavorite(this, '${type}', '${id}', true)"
              class="p-2 text-yellow-500 rounded-full hover:bg-yellow-100 dark:hover:bg-gray-800" 
              title="Retirer des favoris">
              <i data-lucide="star" class="w-5 h-5 fill-yellow-500"></i>
            </button>
          </div>
        `;
      }


      // === NOUVEAU: LOGIQUE DE TOGGLE GÉNÉRALISÉE ===

 /**
       * Fonction générique pour initialiser un widget réductible
       * @param {string} toggleBtnId - ID du bouton (le header)
       * @param {string} contentId - ID du conteneur (la liste)
       * @param {string} chevronId - ID de l'icône chevron (IMPORTANT: doit être sur l'icône)
       * @param {string} storageKey - Clé localStorage pour mémoriser l'état
       * @param {boolean} defaultOpen - État par défaut (true = ouvert)
       */
      function setupToggableWidget(toggleBtnId, contentId, chevronId, storageKey, defaultOpen = true) {
        const toggleBtn = document.getElementById(toggleBtnId);
        const content = document.getElementById(contentId);
        // Note: On ne sélectionne PAS le chevron ici

        if (!toggleBtn || !content) {
          console.warn(`Éléments manquants pour le widget ${storageKey}`);
          return;
        }

        // 1. Déterminer l'état initial
        let isWidgetOpen;
        const savedState = localStorage.getItem(storageKey);
        if (savedState === null) {
          isWidgetOpen = defaultOpen;
        } else {
          isWidgetOpen = (savedState === 'open');
        }

        // 2. Fonction pour mettre à jour l'UI (VERSION CORRIGÉE)
        function updateWidgetVisuals() {
          const newIconName = isWidgetOpen ? 'chevron-up' : 'chevron-down';
          
          if (isWidgetOpen) {
            content.classList.remove('hidden');
          } else {
            content.classList.add('hidden');
          }
          
          // --- DÉBUT DE LA CORRECTION ---
          
          // 1. Trouver l'icône actuelle (qui est un <svg> ou un <i>)
          const currentChevron = document.getElementById(chevronId);
          
          if (currentChevron) {
            // 2. Créer une NOUVELLE balise <i>
            const newChevron = document.createElement('i');
            
            // 3. Lui donner les mêmes attributs que l'ancienne
            newChevron.id = currentChevron.id;
            newChevron.className = currentChevron.className; // Copie les classes (ex: w-6 h-6)
            
            // 4. Définir la NOUVELLE icône
            newChevron.setAttribute('data-lucide', newIconName);
            
            // 5. Remplacer l'ancienne icône (SVG) par la nouvelle (i)
            currentChevron.replaceWith(newChevron);
          }
          
          // 6. Demander à Lucide de redessiner CETTE NOUVELLE icône
          lucide.createIcons();
          
          // --- FIN DE LA CORRECTION ---
        }

        // 3. Appliquer l'état visuel initial
        updateWidgetVisuals();

        // 4. Ajouter l'écouteur d'événement
        toggleBtn.addEventListener('click', () => {
          isWidgetOpen = !isWidgetOpen; // Inverser l'état
          localStorage.setItem(storageKey, isWidgetOpen ? 'open' : 'closed'); // Sauvegarder
          updateWidgetVisuals(); // Mettre à jour l'UI
        });
      }

      // --- APPEL DE TOUTES LES FONCTIONS ---

      // Initialiser les widgets réductibles
      setupToggableWidget('pmr-widget-toggle', 'pmr-issues-list', 'pmr-widget-chevron', 'bacoPmrWidgetState', true);
      setupToggableWidget('journal-widget-toggle', 'journal-recent-list', 'journal-widget-chevron', 'bacoJournalWidgetState', true);


      // --- Appel des fonctions au chargement ---
      loadUserGreeting();
      loadPmrIssuesWidget(); 
      loadRecentJournal();



    };
  </script>
<div id="footer-placeholder"></div>
</body>
</html>