<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Répertoire</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>

<div id="contact-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un contact</h3>
      <button onclick="hideContactModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <form id="contact-form" onsubmit="handleFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="modal-contact-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-tel" class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="modal-tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-email" class="block text-sm font-medium text-gray-700">Email (optionnel)</label>
          <input type="email" id="modal-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-categorie" class="block text-sm font-medium text-gray-700">Catégorie</label>
          <select id="modal-categorie" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="MIA">MIA</option>
            <option value="RCC-OCC">RCC-OCC</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div>
          <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone (optionnel)</label>
          <input type="text" id="modal-zone" placeholder="FMS, FTY, FCR..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-groupe" class="block text-sm font-medium text-gray-700">Groupe</label>
          <input type="text" id="modal-groupe" required placeholder="SPI, CPI, PACO..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideContactModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<body class="h-full bg-gray-50">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    
    <div class="mb-6 flex justify-end admin-only">
      <button onclick="showContactModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un contact</span>
      </button>
    </div>
   
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Répertoire téléphonique</h1>

<div class="mb-4">
      <label for="search-bar" class="block text-sm font-medium text-gray-700">Rechercher (par nom, tél, email ou groupe)</label>
      <div class="relative mt-1 rounded-md shadow-sm">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
        </div>
        <input type="search" id="search-bar" oninput="updateDisplay()" placeholder="David Lejeune, SPI, 0490/..." class="block w-full rounded-md border-gray-300 pl-10 px-4 py-2 focus:border-blue-500 focus:ring-blue-500">
      </div>
    </div>

    <div class="mb-8 flex items-center gap-4">
      <label class="block text-sm font-medium text-gray-700">Trier par nom:</label>
      <div class="flex rounded-md shadow-sm">
        <button id="sort-az" class="relative inline-flex items-center gap-2 rounded-l-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-a-z" class="w-4 h-4"></i>
          <span>A-Z</span>
        </button>
        <button id="sort-za" class="relative -ml-px inline-flex items-center gap-2 rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-z-a" class="w-4 h-4"></i>
          <span>Z-A</span>
        </button>
      </div>
    </div>


    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>
    <div class="flex flex-wrap gap-3 mb-8" id="mainCategories">
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="MIA" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">MIA</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="RCC-OCC" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">RCC - OCC</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Autre" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Autre</span>
      </label>
    </div>

    <div id="miaSubCategoriesContainer" style="display:none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Filtres MIA</h3>
      <div class="flex flex-wrap gap-3 mb-8" id="miaSubCategories">
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FTY" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FTY</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FMS" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FMS</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FCR" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FCR</span>
        </label>
      </div>
    </div>

    <hr class="my-8">
    <div id="resultDisplay">
      <p class="text-gray-600">Veuillez sélectionner une catégorie pour afficher les contacts.</p>
    </div>

  </div>

 <div id="resultDisplay">


<script>
    let currentSortOrder = 'az';
    let updateDisplay;
    let updateSubCategories;
    let deleteContact;
    let showContactModal;
    let hideContactModal;
    let handleFormSubmit;
    
    document.addEventListener('DOMContentLoaded', () => {
    
      const notyf = (typeof Notyf !== 'undefined') 
        ? new Notyf({ duration: 3000, position: { x: 'right', y: 'top' }, dismissible: true })
        : { success: (msg) => alert(msg), error: (msg) => alert(msg) };
      
      // ===================================================
      // ==  NOUVEAU : Création du canal Broadcast  ==
      // ===================================================
      const repertoireChannel = supabaseClient.channel('baco-repertoire');
      // ---------------------------------------------------

      const container = document.getElementById('resultDisplay');
      const modal = document.getElementById('contact-modal');
      // ... (autres variables DOM)
      
      updateSubCategories = () => { /* ... (code inchangé) ... */ }
      updateDisplay = async () => { /* ... (code inchangé) ... */ }
      
      deleteContact = async (id, nom) => {
        if (!confirm(`...`)) return;
        const { error } = await supabaseClient.from('contacts_repertoire').delete().eq('id', id);
        if (error) {
          notyf.error("Erreur: " + error.message);
        } else {
          notyf.success("Contact supprimé !");
          // MODIFIÉ: Envoyer un signal
          repertoireChannel.send({ type: 'broadcast', event: 'data-change' });
          updateDisplay(); // Rafraîchir localement aussi
        }
      }
      
      showContactModal = (contact = null) => { /* ... (code inchangé) ... */ }
      hideContactModal = () => { /* ... (code inchangé) ... */ }
      
      handleFormSubmit = async (event) => {
        event.preventDefault();
        // ... (votre logique de formulaire)
        let error;
        if (isEdit) { /* ... (update) ... */ } else { /* ... (insert) ... */ }
        
        if (error) {
          notyf.error("Erreur: " + error.message);
        } else {
          notyf.success(isEdit ? "Contact mis à jour !" : "Contact ajouté !");
          hideContactModal();
          // MODIFIÉ: Envoyer un signal
          repertoireChannel.send({ type: 'broadcast', event: 'data-change' });
          updateDisplay(); // Rafraîchir localement aussi
        }
      }
      
      // --- Gestion des boutons de tri ---
      // ... (code inchangé pour les boutons de tri) ...
      
      updateSortButtons();
      updateDisplay();

      // ===============================================
      // ==  NOUVEAU : SOUSCRIPTION REALTIME BROADCAST  ==
      // ===============================================
      
      repertoireChannel
        .on(
          'broadcast', 
          { event: 'data-change' },
          (payload) => {
            console.log('Signal de mise à jour reçu pour le répertoire!', payload);
            notyf.success('Répertoire mis à jour...');
            updateDisplay(); // Rafraîchir la vue
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('Connecté au canal temps réel du répertoire.');
          }
        });

    });
  </script>

  <script src="js/layout.js" defer></script>
</body>
</html>