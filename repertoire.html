<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Répertoire</title>
    <link rel="icon" type="image/png" href="favicon.jpg">

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/lucide@0.303.0/dist/umd/lucide.min.js" defer></script>  <script src="js/layout.js" defer></script>
  
  <link rel="stylesheet" href="https://unpkg.com/notyf@3/notyf.min.css">
  <script src="https://unpkg.com/notyf@3/notyf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
  <style>
  /* Cacher le corps par défaut jusqu'à ce que l'auth soit vérifiée */
  body {
    visibility: hidden;
  }
</style>
</head>

<div id="contact-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un contact</h3>
      <button onclick="hideContactModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <form id="contact-form" onsubmit="handleFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="modal-contact-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-tel" class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="modal-tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-email" class="block text-sm font-medium text-gray-700">Email (optionnel)</label>
          <input type="email" id="modal-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-categorie" class="block text-sm font-medium text-gray-700">Catégorie</label>
          <input type="text" id="modal-categorie" required placeholder="MIA, DSE, RCC-OCC..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone (optionnel)</label>
          <input type="text" id="modal-zone" placeholder="FMS, FTY, LT..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-groupe" class="block text-sm font-medium text-gray-700">Groupe</label>
          <input type="text" id="modal-groupe" required placeholder="SPI, CPI, PACO..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideContactModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<body class="h-full flex flex-col min-h-screen bg-gray-50">

  <div id="nav-placeholder"></div>
<div class="flex-grow">
  <div class="container mx-auto p-8">
    
    <div class="mb-6 flex justify-end admin-only">
      <button onclick="showContactModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un contact</span>
      </button>
    </div>
   
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Répertoire téléphonique</h1>

<div class="mb-4">
      <label for="search-bar" class="block text-sm font-medium text-gray-700">Rechercher (par nom, tél, email ou groupe)</label>
      <div class="relative mt-1 rounded-md shadow-sm">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
        </div>
        <input type="search" id="search-bar" oninput="updateDisplay()" placeholder="Mathieu Debaisieux, Eddy Derèse, ..." class="block w-full rounded-md border-gray-300 pl-10 px-4 py-2 focus:border-blue-500 focus:ring-blue-500">
      </div>
    </div>

    <div class="mb-8 flex items-center gap-4">
      <label class="block text-sm font-medium text-gray-700">Trier par nom:</label>
      <div class="flex rounded-md shadow-sm">
        <button id="sort-az" class="relative inline-flex items-center gap-2 rounded-l-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-a-z" class="w-4 h-4"></i>
          <span>A-Z</span>
        </button>
        <button id="sort-za" class="relative -ml-px inline-flex items-center gap-2 rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-z-a" class="w-4 h-4"></i>
          <span>Z-A</span>
        </button>
      </div>
    </div>

    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>
    <div class="flex flex-wrap gap-3 mb-8" id="mainCategories">
      <p class="text-gray-600">Chargement des catégories...</p>
    </div>

    <div id="zoneSubCategoriesContainer" style="display:none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Filtres de Zone</h3>
      <div class="flex flex-wrap gap-3 mb-8" id="zoneSubCategories">
         <p class="text-gray-600">Chargement des zones...</p>
      </div>
    </div>
    
    <hr class="my-8">
    <div id="resultDisplay">
      <p class="text-gray-600">Veuillez sélectionner une catégorie pour afficher les contacts.</p>
    </div>

  </div>
</div>
<script>
    // Déclarer les fonctions modales globalement pour les 'onclick'
    let showContactModal;
    let hideContactModal;
    let handleFormSubmit;
    let deleteContact;
    let updateSubCategories;
    let updateDisplay;

    // La page attend que layout.js appelle window.pageInit()
    window.pageInit = function() {
    
      // On n'initialise PAS notyf, on l'utilise (il est global)
      if (typeof notyf === 'undefined') {
        console.error('Notyf n\'est pas chargé !');
      }

      // --- Définition des variables ---
      const resultDisplay = document.getElementById('result-display');
      const searchInput = document.getElementById('search-bar');
      const filterContainer = document.getElementById('mainCategories'); // Renommé pour correspondre au HTML
      const zoneContainer = document.getElementById('zoneSubCategoriesContainer');
      const zoneCheckboxContainer = document.getElementById('zoneSubCategories');
      const sortAzButton = document.getElementById('sort-az');
      const sortZaButton = document.getElementById('sort-za');
      const modal = document.getElementById('contact-modal');
      const modalTitle = document.getElementById('modal-title');
      const contactForm = document.getElementById('contact-form');
      const contactIdInput = document.getElementById('modal-contact-id');

      let currentSortOrder = 'az';
      let favoritedContactIds = new Set();
      let allContactsData = []; // Cache pour les données
      
      
      /**
       * Charge dynamiquement les catégories principales depuis Supabase
       */
      async function loadMainCategories() {
        try {
          // Charger les données (seulement si le cache est vide)
          if (allContactsData.length === 0) {
              const { data, error } = await supabaseClient
                .from('contacts_repertoire')
                .select('*');
              if (error) throw error;
              allContactsData = data; // Mettre en cache
          }
            
          // Construire les filtres de catégorie
          const categories = [...new Set(allContactsData.map(p => p.categorie_principale))].filter(Boolean).sort();
          filterContainer.innerHTML = categories.map(categorie => `
            <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
              <input type="checkbox" value="${categorie}" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
              <span class="font-medium text-gray-700">${categorie}</span>
            </label>
          `).join('');
          
        } catch (error) {
          filterContainer.innerHTML = `<p class="text-red-600">Erreur chargement catégories: ${error.message}</p>`;
        }
      }

      /**
       * Peuple dynamiquement les filtres de zone
       */
      async function populateZoneFilters(selectedMainCategories) {
        zoneCheckboxContainer.innerHTML = '<p class="text-gray-600">Chargement des zones...</p>';
        const zonableCategories = ['MIA', 'DSE'];
        const relevantCategories = selectedMainCategories.filter(cat => zonableCategories.includes(cat));

        if (relevantCategories.length === 0) {
            zoneCheckboxContainer.innerHTML = '';
            return;
        }

        try {
            // Pas besoin de requêter à nouveau, on filtre le cache
            const zones = [...new Set(
                allContactsData
                    .filter(item => relevantCategories.includes(item.categorie_principale))
                    .map(item => item.zone)
            )].filter(Boolean).sort();
            
            if (zones.length === 0) {
                zoneCheckboxContainer.innerHTML = '<p class="text-xs text-gray-500">Aucune zone de filtre trouvée.</p>';
                return;
            }

            zoneCheckboxContainer.innerHTML = zones.map(zone => `
                <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
                    <input type="checkbox" value="${zone}" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
                    <span class="font-medium text-gray-700">${zone}</span>
                </label>
            `).join('');
            
        } catch (error) {
            zoneCheckboxContainer.innerHTML = `<p class="text-red-600">Erreur zones: ${error.message}</p>`;
        }
      }

      /**
       * Met à jour l'affichage des sous-catégories (zones)
       */
      updateSubCategories = async () => {
        const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
        const zonableCategories = ['MIA', 'DSE']; 
        const showZoneFilters = mainChecked.some(cat => zonableCategories.includes(cat));

        if (showZoneFilters) {
            zoneContainer.style.display = 'block';
            await populateZoneFilters(mainChecked);
        } else {
            zoneContainer.style.display = 'none';
            zoneCheckboxContainer.innerHTML = '';
        }
        updateDisplay();
      }

      /**
       * Surligne le terme de recherche
       */
      function highlightText(text, term) {
        if (!term || !text) return text;
        try {
          const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const regex = new RegExp(`(${escapedTerm})`, 'gi');
          return text.replace(regex, '<mark class="bg-yellow-200 rounded px-0.5">$1</mark>');
        } catch (e) { return text; }
      }

      /**
       * Charge les favoris et met à jour l'affichage
       */
      async function loadData() {
        resultDisplay.innerHTML = '<div class="flex justify-center items-center py-20"><i data-lucide="loader-2" class="w-10 h-10 text-blue-600 animate-spin"></i></div>';
        lucide.createIcons();

        try {
          // currentUserId est défini par layout.js
          const { data: favs, error: favError } = await supabaseClient
            .from('favoris')
            .select('id_contenu')
            .eq('user_id', currentUserId) 
            .eq('type_contenu', 'repertoire');
            
          if (favError) throw favError;
          favoritedContactIds = new Set(favs.map(f => f.id_contenu));
        } catch (error) {
          resultDisplay.innerHTML = `<p class="text-red-600 text-center">Erreur (auth/favs): ${error.message}</p>`;
          return;
        }

        if (allContactsData.length === 0) {
            try {
                const { data, error } = await supabaseClient
                    .from('contacts_repertoire')
                    .select('*');
                if (error) throw error;
                allContactsData = data;
            } catch (error) {
                resultDisplay.innerHTML = `<p class="text-red-600 text-center">Erreur: ${error.message}</p>`;
                return;
            }
        }
        updateDisplay();
      }

      /**
       * Filtre et affiche les contacts
       */
      updateDisplay = () => {
        const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
        const zoneSubChecked = Array.from(document.querySelectorAll('#zoneSubCategories input:checked')).map(cb => cb.value);
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        const categoriesWithZones = ['MIA', 'DSE'];
        const mainCategoriesWithZones = mainChecked.filter(cat => categoriesWithZones.includes(cat));
        const mainCategoriesWithoutZones = mainChecked.filter(cat => !categoriesWithZones.includes(cat));

        let filteredData = allContactsData.filter(p => {
            // 1. Filtre de recherche
            const searchMatch = !searchTerm || (
                (p.nom && p.nom.toLowerCase().includes(searchTerm)) || 
                (p.tel && p.tel.toLowerCase().includes(searchTerm)) || 
                (p.email && p.email.toLowerCase().includes(searchTerm)) || 
                (p.groupe && p.groupe.toLowerCase().includes(searchTerm))
            );
            if (!searchMatch) return false;

            // 2. Filtre de catégorie (si aucun filtre n'est coché, on affiche tout)
            if (mainChecked.length === 0) return true;

            // 3. Logique de filtrage combiné
            let categoryMatch = false;
            // Vérifier les catégories sans zone
            if (mainCategoriesWithoutZones.includes(p.categorie_principale)) {
                categoryMatch = true;
            }
            // Vérifier les catégories AVEC zone
            if (mainCategoriesWithZones.includes(p.categorie_principale)) {
                if (zoneSubChecked.length === 0) {
                    categoryMatch = true; // Si la cat principale est cochée mais aucune zone, on affiche tout de cette cat
                } else if (zoneSubChecked.includes(p.zone)) {
                    categoryMatch = true;
                }
                // Cas spécial pour TL/MPI
                if (p.categorie_principale === 'MIA' && p.zone === 'FMS' && p.groupe === 'TL/MPI' && zoneSubChecked.includes('FTY')) {
                    categoryMatch = true;
                }
            }
            
            return categoryMatch;
        });

        // 4. Trier les résultats
        filteredData.sort((a, b) => {
            if (currentSortOrder === 'az') {
                return a.nom.localeCompare(b.nom);
            } else {
                return b.nom.localeCompare(a.nom);
            }
        });

        if (filteredData.length === 0) {
          resultDisplay.innerHTML = `<p class="text-gray-600 text-center">Aucun contact trouvé pour les filtres actuels.</p>`;
          return;
        }
        
        let currentGroup = "";
        resultDisplay.innerHTML = filteredData.map(p => {
          let groupHeader = "";
          // N'afficher l'en-tête de groupe que si on n'a pas de filtre de catégorie ou de recherche
          if (p.groupe !== currentGroup && mainChecked.length === 0 && !searchTerm) {
            currentGroup = p.groupe;
            groupHeader = `<h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3 col-span-full">${currentGroup}</h3>`;
          }
          
          const isFavorited = favoritedContactIds.has(p.id.toString());
          const starClass = isFavorited ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400';
          
          const favoriteButton = `
            <button onclick="window.toggleFavorite(this, 'repertoire', '${p.id}', ${isFavorited})" class="p-1 rounded-full hover:bg-yellow-100" title="Mettre en favori">
              <i data-lucide="star" class="w-4 h-4 ${starClass}"></i>
            </button>
          `;
          
          const emailHtml = p.email
            ? `<a href="mailto:${p.email}" class="flex items-center gap-2 text-sm font-mono text-gray-600 hover:text-blue-800 transition-colors" title="${p.email}"><i data-lucide="mail" class="w-4 h-4"></i><span class="truncate" style="max-width: 200px;">${p.email}</span></a>`
            : '';
            
          const telHtml = (p.tel === '(manquant)' || !p.tel)
            ? `<span class="flex items-center gap-2 text-sm font-mono text-gray-500"><i data-lucide="phone-off" class="w-4 h-4"></i><span>(manquant)</span></span>`
            : `<a href="etrali:${p.tel}" class="flex items-center gap-2 text-sm font-mono text-blue-600 hover:text-blue-800 transition-colors"><i data-lucide="phone" class="w-4 h-4"></i><span>${p.tel}</span></a>`;

          return groupHeader + `
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center contact-card" data-category="${p.groupe}">
              <div class="flex items-center gap-3">
                <i data-lucide="user" class="w-5 h-5 text-gray-400"></i>
                <div>
                  <p class="font-semibold text-gray-900">${p.nom}</p>
                  <p class="text-sm text-gray-600">${p.service || ''}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                ${telHtml}
                ${emailHtml}
                ${favoriteButton}
                <div class="admin-only flex items-center gap-2">
                  <button onclick="showContactModal(${JSON.stringify(p).replace(/"/g, "&quot;")})" class="p-1 text-blue-600 rounded hover:bg-blue-100" title="Modifier">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                  </button>
                  <button onclick="deleteContact(${p.id}, '${p.nom}')" class="p-1 text-red-600 rounded hover:bg-red-100" title="Supprimer">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        lucide.createIcons();
        if (window.hideAdminElements) window.hideAdminElements();
      }

      window.filterContacts = (category, element) => {
        document.querySelectorAll('#mainCategories input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        
        document.querySelectorAll('#filter-container button').forEach(btn => {
          btn.classList.remove('bg-blue-100', 'text-blue-700');
          btn.classList.add('text-gray-600', 'hover:bg-gray-200');
        });
        element.classList.add('bg-blue-100', 'text-blue-700');
        element.classList.remove('text-gray-600', 'hover:bg-gray-200');
        
        updateDisplay();
      }

      function updateSortButtons() {
        if (currentSortOrder === 'az') {
          sortAzButton.classList.add('bg-blue-100', 'text-blue-700', 'ring-blue-300');
          sortZaButton.classList.remove('bg-blue-100', 'text-blue-700', 'ring-blue-300');
        } else {
          sortZaButton.classList.add('bg-blue-100', 'text-blue-700', 'ring-blue-300');
          sortAzButton.classList.remove('bg-blue-100', 'text-blue-700', 'ring-blue-300');
        }
      }
      sortAzButton.addEventListener('click', () => {
        if (currentSortOrder === 'az') return;
        currentSortOrder = 'az';
        updateSortButtons();
        updateDisplay();
      });
      sortZaButton.addEventListener('click', () => {
        if (currentSortOrder === 'za') return;
        currentSortOrder = 'za';
        updateSortButtons();
        updateDisplay();
      });

      // --- Écouteurs ---
      searchInput.addEventListener('input', () => updateDisplay());
      
      // --- Lancement ---
      updateSortButtons();
      loadData();
      loadMainCategories(); // Charger les catégories
    
      // --- Fonctions Modales ---
      showContactModal = (contact = null) => {
        const isEdit = contact !== null;
        contactForm.reset();
        
        if (isEdit) {
          modalTitle.textContent = 'Modifier le contact';
          contactIdInput.value = contact.id;
          document.getElementById('modal-nom').value = contact.nom;
          document.getElementById('modal-tel').value = contact.tel;
          document.getElementById('modal-email').value = contact.email || '';
          document.getElementById('modal-categorie').value = contact.categorie_principale;
          document.getElementById('modal-zone').value = contact.zone || '';
          document.getElementById('modal-groupe').value = contact.groupe;
        } else {
          modalTitle.textContent = 'Ajouter un contact';
          contactIdInput.value = '';
        }
        
        modal.style.display = 'flex';
        lucide.createIcons();
      }

      hideContactModal = () => {
        modal.style.display = 'none';
      }

      handleFormSubmit = async (event) => {
        event.preventDefault();
        
        const contactId = contactIdInput.value;
        const isEdit = contactId !== '';
        
        const contactData = {
          nom: document.getElementById('modal-nom').value,
          tel: document.getElementById('modal-tel').value,
          email: document.getElementById('modal-email').value || null,
          categorie_principale: document.getElementById('modal-categorie').value,
          zone: document.getElementById('modal-zone').value || null,
          groupe: document.getElementById('modal-groupe').value
        };

        let error;
        const submitButton = document.getElementById('modal-submit-button');
        submitButton.disabled = true;
        submitButton.textContent = 'Enregistrement...';

        if (isEdit) {
          const { error: updateError } = await supabaseClient
            .from('contacts_repertoire')
            .update(contactData)
            .eq('id', contactId);
          error = updateError;
        } else {
          const { error: insertError } = await supabaseClient
            .from('contacts_repertoire')
            .insert([contactData]);
          error = insertError;
        }

        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';

        if (error) {
          notyf.error("Erreur: " + error.message);
        } else {
          notyf.success(isEdit ? "Contact mis à jour !" : "Contact ajouté !");
          hideContactModal();
          allContactsData = []; // Vider le cache
          loadData();
          loadMainCategories(); 
        }
      }
      
      deleteContact = async (id, nom) => {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer le contact "${nom}" ?`)) {
          return;
        }
        const { error } = await supabaseClient.from('contacts_repertoire').delete().eq('id', id);
        if (error) {
          notyf.error("Erreur: " + error.message);
        } else {
          notyf.success("Contact supprimé !");
          await supabaseClient.from('favoris').delete().match({ id_contenu: id.toString(), type_contenu: 'repertoire' });
          allContactsData = []; // Vider le cache
          loadData();
          loadMainCategories(); 
        }
      }
    
    }; // Fin de window.pageInit
  </script>
  
  <div id="footer-placeholder"></div>
  
</body>
</html>