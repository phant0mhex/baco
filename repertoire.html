<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Répertoire</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>
<body class="h-full bg-gray-50">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    
    <div class="mb-6 flex justify-end">
      <button onclick="showContactModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un contact</span>
      </button>
    </div>
    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>


    <h1 class="text-3xl font-bold text-gray-800 mb-6">Répertoire téléphonique</h1>

    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>
    <div class="flex flex-wrap gap-3 mb-8" id="mainCategories">
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="MIA" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">MIA</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="RCC-OCC" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">RCC - OCC</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Autre" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Autre</span>
      </label>
    </div>

    <div id="miaSubCategoriesContainer" style="display:none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Filtres MIA</h3>
      <div class="flex flex-wrap gap-3 mb-8" id="miaSubCategories">
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FTY" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FTY</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FMS" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FMS</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FCR" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FCR</span>
        </label>
      </div>
    </div>

    <hr class="my-8">
    <div id="resultDisplay">
      <p class="text-gray-600">Veuillez sélectionner une catégorie pour afficher les contacts.</p>
    </div>

  </div>

 <div id="resultDisplay">


  <script>
    // --- FONCTIONS LOGIQUES (MODIFIÉES) ---

    function updateSubCategories() {
      const miaChecked = document.querySelector('#mainCategories input[value="MIA"]').checked;
      document.getElementById('miaSubCategoriesContainer').style.display = miaChecked ? 'block' : 'none';
      updateDisplay();
    }

    async function updateDisplay() {
      const container = document.getElementById('resultDisplay');
      container.innerHTML = '<p class="text-gray-600">Chargement...</p>';

      const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
      const miaSubChecked = Array.from(document.querySelectorAll('#miaSubCategories input:checked')).map(cb => cb.value);
      
      let hasContent = false;
      const columns = {};

      if (mainChecked.length > 0) {
        // --- MODIFICATION 1 : 'id' est ajouté au select ---
        let query = supabaseClient
          .from('contacts_repertoire')
          .select('id, nom, tel, groupe, email, categorie_principale, zone'); // <-- ID et champs de filtre ajoutés

        const orFilters = [];
        
        if (mainChecked.includes('MIA') && miaSubChecked.length > 0) {
          if (miaSubChecked.includes('FMS')) {
            orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FMS)`);
          }
          if (miaSubChecked.includes('FCR')) {
            orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FCR)`);
          }
          if (miaSubChecked.includes('FTY')) {
            orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FTY)`);
            orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FMS,groupe.eq.TL/MPI)`);
          }
        }
        
        if (mainChecked.includes('RCC-OCC')) {
          orFilters.push('categorie_principale.eq.RCC-OCC');
        }
        if (mainChecked.includes('Autre')) {
          orFilters.push('categorie_principale.eq.Autre');
        }

        if (orFilters.length > 0) {
          query = query.or(orFilters.join(','));
          
          const { data: contacts, error } = await query;

          if (error) {
            container.innerHTML = `<p class='text-red-600'>Erreur: ${error.message}</p>`;
            return;
          }

          for (const contact of contacts) {
            const col = contact.groupe;
            if (!columns[col]) columns[col] = [];
            columns[col].push(contact);
            hasContent = true;
          }
        }
      }

      // --- MODIFICATION 2 : Affichage des boutons ---
      let outputHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
      const sortedKeys = Object.keys(columns).sort();

      for (const col of sortedKeys) {
          outputHTML += `<div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">`;
          outputHTML += `<h3 class="text-xl font-semibold text-gray-900 p-4 border-b bg-gray-50">${col}</h3>`;
          outputHTML += `<div class="flex flex-col gap-3 p-4">`;
          
          outputHTML += columns[col].map(p => {
            
            const telHtml = (p.tel === '(manquant)')
              ? `<span class="flex items-center gap-2 text-sm font-mono text-gray-500">...</span>`
              : `<a href="tel:${p.tel}" class="flex items-center gap-2 text-sm font-mono text-blue-600 ...">...<span>${p.tel}</span></a>`;

            const emailHtml = p.email
              ? `<a href="mailto:${p.email}" class="flex items-center gap-2 text-sm font-mono text-gray-600 ...">...<span class="truncate" ...>${p.email}</span></a>`
              : '';
            
            // Pour passer l'objet 'p' en paramètre, on le stringify et on échappe les guillemets
            const contactJson = JSON.stringify(p).replace(/"/g, "&quot;");

            return `
              <div class="p-3 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between">
                  <span class="flex items-center gap-2.5 text-sm font-medium text-gray-900">
                     <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                     <span>${p.nom}</span>
                  </span>
                  <div class="flex flex-col items-end gap-1">
                    ${telHtml.replace(/\.\.\./g, '')}
                    ${emailHtml.replace(/\.\.\./g, '')}
                  </div>
                </div>
                <div class="flex items-center justify-end gap-2 mt-2 pt-2 border-t border-gray-200">
                  <button onclick="showContactModal(${contactJson})" class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-blue-600 bg-blue-100 rounded hover:bg-blue-200">
                    <i data-lucide="pencil" class="w-3 h-3"></i> Modifier
                  </button>
                  <button onclick="deleteContact(${p.id}, '${p.nom}')" class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded hover:bg-red-200">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Supprimer
                  </button>
                </div>
              </div>`;
          }).join('');
          
          outputHTML += `</div></div>`;
      }
      outputHTML += '</div>';

      if (!hasContent) {
        container.innerHTML = '<p class="text-gray-600">Veuillez sélectionner une catégorie (et une sous-catégorie si MIA) pour afficher les contacts.</p>';
      } else {
        container.innerHTML = outputHTML;
      }
      
      lucide.createIcons();
    }
    
    document.addEventListener('DOMContentLoaded', updateDisplay);

    
    // --- NOUVELLES FONCTIONS D'ÉDITION ET SUPPRESSION ---

    /**
     * Gère la suppression d'un contact
     */
    async function deleteContact(id, nom) {
      // Demande de confirmation
      if (!confirm(`Êtes-vous sûr de vouloir supprimer le contact "${nom}" ?`)) {
        return;
      }

      // Requête de suppression à Supabase
      const { error } = await supabaseClient
        .from('contacts_repertoire')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Erreur lors de la suppression: " + error.message);
      } else {
        alert("Contact supprimé avec succès !");
        updateDisplay(); // Rafraîchir la liste
      }
    }

    /**
     * Affiche un formulaire pour AJOUTER ou MODIFIER un contact.
     * Si 'contact' est null, c'est un ajout.
     * Si 'contact' est fourni, c'est une modification.
     */
    async function showContactModal(contact = null) {
      const isEdit = contact !== null;
      const title = isEdit ? 'Modifier le contact' : 'Ajouter un contact';

      // On utilise des 'prompt' pour un formulaire simple.
      // C'est basique mais évite de construire un modal HTML complexe.
      const nom = prompt(`Nom:`, isEdit ? contact.nom : '');
      if (nom === null) return; // Annulé
      
      const tel = prompt(`Téléphone:`, isEdit ? contact.tel : '');
      if (tel === null) return; // Annulé

      const email = prompt(`Email (optionnel):`, isEdit ? contact.email : '');
      if (email === null) return; // Annulé

      const categorie = prompt(`Catégorie (MIA, RCC-OCC, Autre):`, isEdit ? contact.categorie_principale : 'MIA');
      if (categorie === null) return; // Annulé

      const zone = prompt(`Zone (FMS, FTY, FCR, ou vide):`, isEdit ? contact.zone : '');
      if (zone === null) return; // Annulé

      const groupe = prompt(`Groupe (SPI, CPI, PACO, etc.):`, isEdit ? contact.groupe : '');
      if (groupe === null) return; // Annulé

      // Préparation de l'objet de données
      const contactData = {
        nom: nom,
        tel: tel,
        email: email || null, // Mettre null si c'est vide
        categorie_principale: categorie,
        zone: zone || null,
        groupe: groupe
      };

      let error;
      if (isEdit) {
        // --- REQUÊTE UPDATE ---
        const { error: updateError } = await supabaseClient
          .from('contacts_repertoire')
          .update(contactData)
          .eq('id', contact.id);
        error = updateError;
      } else {
        // --- REQUÊTE INSERT ---
        const { error: insertError } = await supabaseClient
          .from('contacts_repertoire')
          .insert([contactData]); // L'insertion attend un tableau
        error = insertError;
      }

      // Gestion du résultat
      if (error) {
        alert("Erreur lors de l'opération: " + error.message);
      } else {
        alert(isEdit ? "Contact mis à jour !" : "Contact ajouté !");
        updateDisplay(); // Rafraîchir la liste
      }
    }
  </script>
  
  <script src="js/layout.js" defer></script>
</body>
</html>