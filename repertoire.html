<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Répertoire</title>
    <link rel="icon" type="image/png" href="favicon.jpg">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="js/layout.js" defer></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>

<div id="contact-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un contact</h3>
      <button onclick="hideContactModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <form id="contact-form" onsubmit="handleFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="modal-contact-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-tel" class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="modal-tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-email" class="block text-sm font-medium text-gray-700">Email (optionnel)</label>
          <input type="email" id="modal-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-categorie" class="block text-sm font-medium text-gray-700">Catégorie</label>
          <input type="text" id="modal-categorie" required placeholder="MIA, DSE, RCC-OCC..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone (optionnel)</label>
          <input type="text" id="modal-zone" placeholder="FMS, FTY, LT..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-groupe" class="block text-sm font-medium text-gray-700">Groupe</label>
          <input type="text" id="modal-groupe" required placeholder="SPI, CPI, PACO..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideContactModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<body class="h-full flex flex-col min-h-screen bg-gray-50">

  <div id="nav-placeholder"></div>
<div class="flex-grow">
  <div class="container mx-auto p-8">
    
    <div class="mb-6 flex justify-end admin-only">
      <button onclick="showContactModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un contact</span>
      </button>
    </div>
   
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Répertoire téléphonique</h1>

<div class="mb-4">
      <label for="search-bar" class="block text-sm font-medium text-gray-700">Rechercher (par nom, tél, email ou groupe)</label>
      <div class="relative mt-1 rounded-md shadow-sm">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
        </div>
        <input type="search" id="search-bar" oninput="updateDisplay()" placeholder="Mathieu Debaisieux, Eddy Derèse, ..." class="block w-full rounded-md border-gray-300 pl-10 px-4 py-2 focus:border-blue-500 focus:ring-blue-500">
      </div>
    </div>

    <div class="mb-8 flex items-center gap-4">
      <label class="block text-sm font-medium text-gray-700">Trier par nom:</label>
      <div class="flex rounded-md shadow-sm">
        <button id="sort-az" class="relative inline-flex items-center gap-2 rounded-l-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-a-z" class="w-4 h-4"></i>
          <span>A-Z</span>
        </button>
        <button id="sort-za" class="relative -ml-px inline-flex items-center gap-2 rounded-r-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">
          <i data-lucide="arrow-down-z-a" class="w-4 h-4"></i>
          <span>Z-A</span>
        </button>
      </div>
    </div>

    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>
    <div class="flex flex-wrap gap-3 mb-8" id="mainCategories">
      <p class="text-gray-600">Chargement des catégories...</p>
    </div>

    <div id="zoneSubCategoriesContainer" style="display:none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Filtres de Zone</h3>
      <div class="flex flex-wrap gap-3 mb-8" id="zoneSubCategories">
         <p class="text-gray-600">Chargement des zones...</p>
      </div>
    </div>
    
    <hr class="my-8">
    <div id="resultDisplay">
      <p class="text-gray-600">Veuillez sélectionner une catégorie pour afficher les contacts.</p>
    </div>

  </div>
</div>
 <script>
    let currentSortOrder = 'az';
    
    let currentUserId;
    let favoritedContactIds = new Set();
    
    const notyf = (typeof Notyf !== 'undefined') 
        ? new Notyf({ duration: 3000, position: { x: 'right', y: 'top' }, dismissible: true })
        : { success: (msg) => alert(msg), error: (msg) => alert(msg) };
    
    /**
     * Gère l'ajout ou la suppression d'un favori
     */
    async function toggleFavorite(element, type, id, isFavorited) {
      if (!currentUserId) {
        notyf.error("Erreur: Utilisateur non identifié.");
        return;
      }
      
      element.disabled = true;
      element.classList.add('opacity-50', 'cursor-wait');
      
      // ======================= CORRECTION =======================
      // CIBLER L'ICÔNE À L'INTÉRIEUR DU BOUTON
      const icon = element.querySelector('i');
      if (!icon) return; // Sécurité
      // ==========================================================

      try {
        if (isFavorited) {
          // --- Le supprimer ---
          const { error } = await supabaseClient.from('favoris').delete()
            .match({ user_id: currentUserId, id_contenu: id, type_contenu: type });
          if (error) throw error;
          
          favoritedContactIds.delete(id);
          
          // ======================= CORRECTION =======================
          icon.classList.remove('fill-yellow-400', 'text-yellow-400');
          icon.classList.add('text-gray-400');
          // ==========================================================
          
          element.setAttribute('onclick', `toggleFavorite(this, '${type}', ${id}, false)`);
          
        } else {
          // --- L'ajouter ---
          const { error } = await supabaseClient.from('favoris')
            .insert({ user_id: currentUserId, id_contenu: id, type_contenu: type });
          if (error) throw error;
          
          favoritedContactIds.add(id);
          
          // ======================= CORRECTION =======================
          icon.classList.add('fill-yellow-400', 'text-yellow-400');
          icon.classList.remove('text-gray-400');
          // ==========================================================
          
          element.setAttribute('onclick', `toggleFavorite(this, '${type}', ${id}, true)`);
        }
      } catch (error) {
        notyf.error("Erreur: " + error.message);
      } finally {
        element.disabled = false;
        element.classList.remove('opacity-50', 'cursor-wait');
      }
    }
    
    /**
     * Charge dynamiquement les catégories principales depuis Supabase
     */
    async function loadMainCategories() {
      // ... (code inchangé) ...
      const categoriesContainer = document.getElementById('mainCategories');
      try {
        const { data, error } = await supabaseClient
          .from('contacts_repertoire')
          .select('categorie_principale');
        if (error) throw error;
        const categories = [...new Set(data.map(item => item.categorie_principale))]
          .filter(Boolean)
          .sort();
        if (categories.length === 0) {
           categoriesContainer.innerHTML = '<p class="text-gray-600">Aucune catégorie trouvée.</p>';
           return;
        }
        categoriesContainer.innerHTML = categories.map(categorie => `
          <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
            <input type="checkbox" value="${categorie}" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
            <span class="font-medium text-gray-700">${categorie}</span>
          </label>
        `).join('');
      } catch (error) {
        categoriesContainer.innerHTML = `<p class="text-red-600">Erreur chargement catégories: ${error.message}</p>`;
      }
    }


    /**
     * Peuple dynamiquement les filtres de zone en fonction des catégories principales sélectionnées
     */
    async function populateZoneFilters(selectedMainCategories) {
        // ... (code inchangé) ...
        const zoneCheckboxContainer = document.getElementById('zoneSubCategories');
        zoneCheckboxContainer.innerHTML = '<p class="text-gray-600">Chargement des zones...</p>';
        
        const zonableCategories = ['MIA', 'DSE'];
        const relevantCategories = selectedMainCategories.filter(cat => zonableCategories.includes(cat));

        if (relevantCategories.length === 0) {
            zoneCheckboxContainer.innerHTML = '';
            return;
        }

        try {
            const { data, error } = await supabaseClient
                .from('contacts_repertoire')
                .select('zone')
                .in('categorie_principale', relevantCategories);
            
            if (error) throw error;

            const zones = [...new Set(data.map(item => item.zone))].filter(Boolean).sort();
            
            if (zones.length === 0) {
                zoneCheckboxContainer.innerHTML = '<p class="text-xs text-gray-500">Aucune zone de filtre trouvée pour cette sélection.</p>';
                return;
            }

            zoneCheckboxContainer.innerHTML = zones.map(zone => `
                <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
                    <input type="checkbox" value="${zone}" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
                    <span class="font-medium text-gray-700">${zone}</span>
                </label>
            `).join('');
            
        } catch (error) {
            zoneCheckboxContainer.innerHTML = `<p class="text-red-600">Erreur zones: ${error.message}</p>`;
        }
    }

    /**
     * Met à jour l'affichage des sous-catégories (zones)
     */
    async function updateSubCategories() {
      // ... (code inchangé) ...
      const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
      const zonableCategories = ['MIA', 'DSE']; 
      
      const showZoneFilters = mainChecked.some(cat => zonableCategories.includes(cat));
      
      const zoneContainer = document.getElementById('zoneSubCategoriesContainer');
      const zoneCheckboxContainer = document.getElementById('zoneSubCategories');

      if (showZoneFilters) {
          zoneContainer.style.display = 'block';
          await populateZoneFilters(mainChecked);
      } else {
          zoneContainer.style.display = 'none';
          zoneCheckboxContainer.innerHTML = '';
      }
      
      updateDisplay();
    }

    /**
     * Surligne le terme de recherche dans un texte
     */
    function highlightText(text, term) {
      if (!term || !text) {
        return text;
      }
      try {
        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedTerm})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200 rounded px-0.5">$1</mark>');
      } catch (e) {
        console.error("Erreur de surlignage:", e);
        return text;
      }
    }

    async function updateDisplay() {
      const container = document.getElementById('resultDisplay');
      
      container.innerHTML = '<div class="flex justify-center items-center py-10"><i data-lucide="loader-2" class="w-8 h-8 text-blue-600 animate-spin"></i></div>';
      lucide.createIcons();

      try {
        if (!currentUserId) {
          const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
          if (authError || !user) throw new Error("Utilisateur non connecté");
          currentUserId = user.id;
        }
        
        const { data: favs, error: favError } = await supabaseClient
          .from('favoris')
          .select('id_contenu')
          .eq('user_id', currentUserId)
          .eq('type_contenu', 'contact');
        
        if (favError) throw favError;
        favoritedContactIds = new Set(favs.map(f => f.id_contenu));
        
      } catch (error) {
        container.innerHTML = `<p class='text-red-600'>Erreur (auth/favs): ${error.message}</p>`;
        return;
      }

      const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
      const zoneSubChecked = Array.from(document.querySelectorAll('#zoneSubCategories input:checked')).map(cb => cb.value);
      const searchTerm = document.getElementById('search-bar').value.trim();
      
      let hasContent = false;
      const columns = {};

      let query = supabaseClient
        .from('contacts_repertoire')
        .select('id, nom, tel, groupe, email, categorie_principale, zone')
        .order('nom', { ascending: (currentSortOrder === 'az') });

      const orFilters = [];
      const categoriesWithZones = ['MIA', 'DSE'];
      const mainCategoriesWithZones = mainChecked.filter(cat => categoriesWithZones.includes(cat));
      const mainCategoriesWithoutZones = mainChecked.filter(cat => !categoriesWithZones.includes(cat));
      if (mainCategoriesWithZones.length > 0) {
          if (zoneSubChecked.length > 0) {
              zoneSubChecked.forEach(zone => {
                  if (zone === 'FTY') {
                      if (mainCategoriesWithZones.includes('MIA')) {
                          orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FTY)`);
                          orFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FMS,groupe.eq.TL/MPI)`);
                      }
                      if (mainCategoriesWithZones.includes('DSE')) {
                           orFilters.push(`and(categorie_principale.eq.DSE,zone.eq.FTY)`);
                      }
                  } else {
                      mainCategoriesWithZones.forEach(cat => {
                          orFilters.push(`and(categorie_principale.eq.${cat},zone.eq.${zone})`);
                      });
                  }
              });
          } else {
              mainCategoriesWithZones.forEach(cat => {
                  orFilters.push(`categorie_principale.eq.${cat}`);
              });
          }
      }
      mainCategoriesWithoutZones.forEach(cat => {
          orFilters.push(`categorie_principale.eq.${cat}`);
      });
      if (orFilters.length > 0) {
        query = query.or(orFilters.join(','));
      }
      if (searchTerm) {
        query = query.or(
          `nom.ilike.*${searchTerm}*`,
          `tel.ilike.*${searchTerm}*`,
          `email.ilike.*${searchTerm}*`,
          `groupe.ilike.*${searchTerm}*`
        );
      }
      if (orFilters.length === 0 && !searchTerm) {
          container.innerHTML = '<p class="text-gray-600">Veuillez sélectionner une catégorie ou lancer une recherche.</p>';
          return;
      }
      
      const { data: contacts, error } = await query;
          
      if (error) {
        container.innerHTML = `<p class='text-red-600'>Erreur: ${error.message}</p>`;
        return;
      }

      for (const contact of contacts) {
        const col = contact.groupe;
        if (!columns[col]) columns[col] = [];
        columns[col].push(contact);
        hasContent = true;
      }
      
      let outputHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
      const sortedKeys = Object.keys(columns).sort();

      for (const col of sortedKeys) {
          const colName = highlightText(col, searchTerm);
          outputHTML += `<div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">`;
          outputHTML += `<h3 class="text-xl font-semibold text-gray-900 p-4 border-b bg-gray-50">${colName}</h3>`;
          outputHTML += `<div class="flex flex-col gap-3 p-4">`;
          
          outputHTML += columns[col].map(p => {
            const contactJson = JSON.stringify(p).replace(/"/g, "&quot;");

            const displayName = highlightText(p.nom, searchTerm);
            const displayTel = p.tel ? highlightText(p.tel, searchTerm) : '(manquant)';
            const telHtml = (p.tel === '(manquant)' || !p.tel)
              ? `<span class="flex items-center gap-2 text-sm font-mono text-gray-500"><i data-lucide="phone-off" class="w-4 h-4"></i><span>(manquant)</span></span>`
              : `<a href="etrali:${p.tel}" class="flex items-center gap-2 text-sm font-mono text-blue-600 hover:text-blue-800 transition-colors"><i data-lucide="phone" class="w-4 h-4"></i><span>${displayTel}</span></a>`;
            const displayEmail = p.email ? highlightText(p.email, searchTerm) : '';
            const emailHtml = p.email
              ? `<a href="mailto:${p.email}" class="flex items-center gap-2 text-sm font-mono text-gray-600 hover:text-blue-800 transition-colors" title="${p.email}"><i data-lucide="mail" class="w-4 h-4"></i><span class="truncate" style="max-width: 200px;">${displayEmail}</span></a>`
              : '';

            const isFavorited = favoritedContactIds.has(p.id);
            const starClass = isFavorited ? 'fill-yellow-400 text-yellow-400' : 'text-gray-400';
            const favoriteButton = `
              <button onclick="toggleFavorite(this, 'contact', ${p.id}, ${isFavorited})" class="p-1 rounded-full hover:bg-yellow-100" title="Mettre en favori">
                <i data-lucide="star" class="w-4 h-4 ${starClass}"></i>
              </button>
            `;

            return `
              <div class="bg-gray-50 rounded-lg border border-gray-200 transition-all hover:shadow-sm">
                <div class="flex items-center justify-between p-3 border-b border-gray-100">
                  <span class="flex items-center gap-2.5 text-sm font-medium text-gray-900">
                     <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                     <span>${displayName}</span>
                  </span>
                  
                  <div class="flex items-center gap-1">
                    ${favoriteButton}
                    <div class="admin-only flex items-center gap-2">
                      <button onclick="showContactModal(${contactJson})" class="p-1 text-blue-600 rounded hover:bg-blue-100" title="Modifier">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                      </button>
                      <button onclick="deleteContact(${p.id}, '${p.nom}')" class="p-1 text-red-600 rounded hover:bg-red-100" title="Supprimer">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                  
                </div>
                <div class="p-3 flex flex-col gap-2">
                  ${telHtml}
                  ${emailHtml}
                </div>
              </div>`;
          }).join('');
          
          outputHTML += `</div></div>`;
      }
      outputHTML += '</div>';

      if (!hasContent) {
          let message = searchTerm 
            ? `Aucun contact ne correspond à "${searchTerm}".` 
            : "Aucun contact trouvé pour les filtres sélectionnés.";
          container.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center text-center py-16 px-6 bg-white rounded-lg border border-dashed border-gray-300">
              <i data-lucide="user-x" class="w-16 h-16 text-gray-300"></i>
              <h3 class="mt-4 text-xl font-semibold text-gray-800">Aucun contact trouvé</h3>
              <p class="mt-2 text-sm text-gray-500">${message}</p>
            </div>
          `;
        } else {
          container.innerHTML = outputHTML;
        }
      lucide.createIcons();
    }
    
    document.addEventListener('DOMContentLoaded', async () => { 
      // ... (code des boutons de tri inchangé) ...
      const sortAzButton = document.getElementById('sort-az');
      const sortZaButton = document.getElementById('sort-za');
      function updateSortButtons() {
        if (currentSortOrder === 'az') {
          sortAzButton.classList.add('bg-blue-100', 'text-blue-700', 'ring-blue-300');
          sortZaButton.classList.remove('bg-blue-100', 'text-blue-700', 'ring-blue-300');
        } else {
          sortZaButton.classList.add('bg-blue-100', 'text-blue-700', 'ring-blue-300');
          sortAzButton.classList.remove('bg-blue-100', 'text-blue-700', 'ring-blue-300');
        }
      }
      sortAzButton.addEventListener('click', () => {
        if (currentSortOrder === 'az') return;
        currentSortOrder = 'az';
        updateSortButtons();
        updateDisplay();
      });
      sortZaButton.addEventListener('click', () => {
        if (currentSortOrder === 'za') return;
        currentSortOrder = 'za';
        updateSortButtons();
        updateDisplay();
      });
      updateSortButtons();
      await loadMainCategories();
      updateDisplay();
    });

    
    async function deleteContact(id, nom) {
      if (!confirm(`Êtes-vous sûr de vouloir supprimer le contact "${nom}" ?`)) {
        return;
      }
      const { error } = await supabaseClient.from('contacts_repertoire').delete().eq('id', id);
      if (error) {
        notyf.error("Erreur: " + error.message);
      } else {
        notyf.success("Contact supprimé !");
        // Supprimer aussi des favoris
        await supabaseClient.from('favoris').delete().match({ id_contenu: id, type_contenu: 'contact' });
        updateDisplay();
        await loadMainCategories(); 
      }
    }

    
    const modal = document.getElementById('contact-modal');
    const modalTitle = document.getElementById('modal-title');
    const contactForm = document.getElementById('contact-form');
    const contactIdInput = document.getElementById('modal-contact-id');

    function showContactModal(contact = null) {
      // ... (code inchangé) ...
      const isEdit = contact !== null;
      contactForm.reset();
      
      if (isEdit) {
        modalTitle.textContent = 'Modifier le contact';
        contactIdInput.value = contact.id;
        document.getElementById('modal-nom').value = contact.nom;
        document.getElementById('modal-tel').value = contact.tel;
        document.getElementById('modal-email').value = contact.email || '';
        document.getElementById('modal-categorie').value = contact.categorie_principale;
        document.getElementById('modal-zone').value = contact.zone || '';
        document.getElementById('modal-groupe').value = contact.groupe;
      } else {
        modalTitle.textContent = 'Ajouter un contact';
        contactIdInput.value = '';
      }
      
      modal.style.display = 'flex';
      lucide.createIcons();
    }

    function hideContactModal() {
      modal.style.display = 'none';
    }

    async function handleFormSubmit(event) {
      // ... (code inchangé) ...
      event.preventDefault();
      
      const contactId = contactIdInput.value;
      const isEdit = contactId !== '';
      
      const contactData = {
        nom: document.getElementById('modal-nom').value,
        tel: document.getElementById('modal-tel').value,
        email: document.getElementById('modal-email').value || null,
        categorie_principale: document.getElementById('modal-categorie').value,
        zone: document.getElementById('modal-zone').value || null,
        groupe: document.getElementById('modal-groupe').value
      };

      let error;
      const submitButton = document.getElementById('modal-submit-button');
      submitButton.disabled = true;
      submitButton.textContent = 'Enregistrement...';

      if (isEdit) {
        const { error: updateError } = await supabaseClient
          .from('contacts_repertoire')
          .update(contactData)
          .eq('id', contactId);
        error = updateError;
      } else {
        const { error: insertError } = await supabaseClient
          .from('contacts_repertoire')
          .insert([contactData]);
        error = insertError;
      }

      submitButton.disabled = false;
      submitButton.textContent = 'Enregistrer';

      if (error) {
        notyf.error("Erreur: " + error.message);
      } else {
        notyf.success(isEdit ? "Contact mis à jour !" : "Contact ajouté !");
        hideContactModal();
        updateDisplay();
        await loadMainCategories(); 
      }
    }
  </script>
  
  <div id="footer-placeholder"></div>
  
</body>
</html>