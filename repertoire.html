<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Portail BACO - Répertoire</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>

<div id="contact-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un contact</h3>
      <button onclick="hideContactModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <form id="contact-form" onsubmit="handleFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="modal-contact-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-tel" class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="modal-tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-email" class="block text-sm font-medium text-gray-700">Email (optionnel)</label>
          <input type="email" id="modal-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-categorie" class="block text-sm font-medium text-gray-700">Catégorie</label>
          <select id="modal-categorie" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="MIA">MIA</option>
            <option value="RCC-OCC">RCC-OCC</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div>
          <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone (optionnel)</label>
          <input type="text" id="modal-zone" placeholder="FMS, FTY, FCR..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-groupe" class="block text-sm font-medium text-gray-700">Groupe</label>
          <input type="text" id="modal-groupe" required placeholder="SPI, CPI, PACO..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideContactModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<body class="h-full bg-gray-50">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    
    <div class="mb-6 flex justify-end">
      <button onclick="showContactModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter un contact</span>
      </button>
    </div>
   
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Répertoire téléphonique</h1>

<div class="mb-8">
      <label for="search-bar" class="block text-sm font-medium text-gray-700">Rechercher (par nom, tél, ou email)</label>
      <div class="relative mt-1 rounded-md shadow-sm">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
        </div>
        <input type="search" id="search-bar" oninput="updateDisplay()" placeholder="David Lejeune..." class="block w-full rounded-md border-gray-300 pl-10 px-4 py-2 focus:border-blue-500 focus:ring-blue-500">
      </div>
    </div>


    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Catégories</h3>
    <div class="flex flex-wrap gap-3 mb-8" id="mainCategories">
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="MIA" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">MIA</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="RCC-OCC" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">RCC - OCC</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="Autre" onchange="updateSubCategories()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">Autre</span>
      </label>
    </div>

    <div id="miaSubCategoriesContainer" style="display:none;">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Filtres MIA</h3>
      <div class="flex flex-wrap gap-3 mb-8" id="miaSubCategories">
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FTY" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FTY</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FMS" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FMS</span>
        </label>
        <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
          <input type="checkbox" value="FCR" onchange="updateDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
          <span class="font-medium text-gray-700">FCR</span>
        </label>
      </div>
    </div>

    <hr class="my-8">
    <div id="resultDisplay">
      <p class="text-gray-600">Veuillez sélectionner une catégorie pour afficher les contacts.</p>
    </div>

  </div>

 <div id="resultDisplay">


<script>
    document.addEventListener('DOMContentLoaded', () => {
    
      // --- Références aux éléments du DOM ---
      const modal = document.getElementById('crud-modal');
      const modalTitle = document.getElementById('modal-title');
      const crudForm = document.getElementById('crud-form');
      const itemIdInput = document.getElementById('modal-item-id');
      const container = document.getElementById('resultDisplay');
      const searchBar = document.getElementById('search-bar'); // NOUVEAU

      // --- Exposer les fonctions au HTML ---
      window.showModal = showModal;
      window.hideModal = hideModal;
      window.handleFormSubmit = handleFormSubmit;
      window.deleteItem = deleteItem;
      window.updateDisplay = updateDisplay; // Exposer pour 'oninput'
      window.updateSubCategories = updateSubCategories; // Exposer pour 'onchange'

      // --- FONCTION LOGIQUE (pour les filtres) ---
      function updateSubCategories() {
        const miaChecked = document.querySelector('#mainCategories input[value="MIA"]').checked;
        document.getElementById('miaSubCategoriesContainer').style.display = miaChecked ? 'block' : 'none';
        updateDisplay(); // Déclenche la mise à jour
      }

      // --- AFFICHAGE PRINCIPAL (MODIFIÉ POUR LA RECHERCHE) ---
      async function updateDisplay() {
        container.innerHTML = '<p class="text-gray-600">Chargement...</p>';

        // --- 1. Récupérer tous les filtres ---
        const mainChecked = Array.from(document.querySelectorAll('#mainCategories input:checked')).map(cb => cb.value);
        const miaSubChecked = Array.from(document.querySelectorAll('#miaSubCategories input:checked')).map(cb => cb.value);
        const searchTerm = searchBar.value;

        let hasContent = false;
        const columns = {};

        // --- 2. Construire la requête Supabase ---
        let query = supabaseClient
          .from('contacts_repertoire')
          .select('id, nom, tel, groupe, email, categorie_principale, zone');

        // A. Construire le filtre des catégories (cases à cocher)
        const categoryOrFilters = [];
        if (mainChecked.includes('MIA') && miaSubChecked.length > 0) {
          if (miaSubChecked.includes('FMS')) categoryOrFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FMS)`);
          if (miaSubChecked.includes('FCR')) categoryOrFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FCR)`);
          if (miaSubChecked.includes('FTY')) {
            categoryOrFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FTY)`);
            categoryOrFilters.push(`and(categorie_principale.eq.MIA,zone.eq.FMS,groupe.eq.TL/MPI)`);
          }
        }
        if (mainChecked.includes('RCC-OCC')) categoryOrFilters.push('categorie_principale.eq.RCC-OCC');
        if (mainChecked.includes('Autre')) categoryOrFilters.push('categorie_principale.eq.Autre');

        // B. Construire le filtre de recherche
        let searchOrString = null;
        if (searchTerm) {
          // 'ilike' est insensible à la casse
          searchOrString = `or(nom.ilike.%${searchTerm}%,tel.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%)`;
        }

        // C. Combiner les filtres
        if (categoryOrFilters.length > 0 && searchOrString) {
          // Filtres ET Recherche
          query = query.and(`or(${categoryOrFilters.join(',')}),${searchOrString}`);
        } else if (categoryOrFilters.length > 0) {
          // Juste les filtres
          query = query.or(categoryOrFilters.join(','));
        } else if (searchOrString) {
          // Juste la recherche
          query = query.or(searchOrString);
        } else {
          // Aucun filtre (n'affiche rien)
          container.innerHTML = '<p class="text-gray-600">Veuillez sélectionner une catégorie ou utiliser la recherche.</p>';
          lucide.createIcons();
          return;
        }

        // D. Exécuter la requête
        const { data, error } = await query.order('categorie').order('nom');

        if (error) {
          container.innerHTML = `<p class="text-red-600">Erreur: ${error.message}</p>`;
          lucide.createIcons();
          return;
        }

        // --- 3. Rendu HTML (inchangé) ---
        for (const item of data) {
          if (!columns[item.groupe]) {
            columns[item.groupe] = [];
          }
          columns[item.groupe].push(item);
          hasContent = true;
        }
        
        let outputHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
        const sortedCategories = Object.keys(columns).sort();

        for (const categorie of sortedCategories) {
          outputHTML += `<div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">`;
          outputHTML += `<h3 class="text-xl font-semibold text-gray-900 p-4 border-b bg-gray-50">${categorie}</h3>`;
          outputHTML += `<div class="flex flex-col gap-3 p-4">`;
          
          outputHTML += columns[categorie].map(p => {
            const itemJson = JSON.stringify(p).replace(/"/g, "&quot;");
            const telHtml = (p.tel === '(manquant)' || !p.tel)
              ? `<span class="flex items-center gap-2 text-sm font-mono text-gray-500"><i data-lucide="phone-off" class="w-4 h-4"></i><span>(manquant)</span></span>`
              : `<a href="tel:${p.tel}" class="flex items-center gap-2 text-sm font-mono text-blue-600 hover:text-blue-800 transition-colors"><i data-lucide="phone" class="w-4 h-4"></i><span>${p.tel}</span></a>`;
            const emailHtml = p.email
              ? `<a href="mailto:${p.email}" class="flex items-center gap-2 text-sm font-mono text-gray-600 hover:text-blue-800 transition-colors" title="${p.email}"><i data-lucide="mail" class="w-4 h-4"></i><span class="truncate" style="max-width: 200px;">${p.email}</span></a>`
              : '';

            return `
              <div class="bg-gray-50 rounded-lg border border-gray-200 transition-all hover:shadow-sm">
                <div class="flex items-center justify-between p-3 border-b border-gray-100">
                  <span class="flex items-center gap-2.5 text-sm font-medium text-gray-900">
                     <i data-lucide="user" class="w-4 h-4 text-gray-600"></i>
                     <span>${p.nom}</span>
                  </span>
                  <div class="flex items-center gap-2">
                    <button onclick="showModal(${itemJson})" class="p-1 text-blue-600 rounded hover:bg-blue-100" title="Modifier">
                      <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                    <button onclick="deleteItem(${p.id}, '${p.nom}')" class="p-1 text-red-600 rounded hover:bg-red-100" title="Supprimer">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
                <div class="p-3 flex flex-col gap-2">
                  ${telHtml}
                  ${emailHtml}
                </div>
              </div>`;
          }).join('');
          
          outputHTML += `</div></div>`;
        }
        outputHTML += '</div>';

        if (!hasContent) {
          container.innerHTML = '<p class="text-gray-600">Aucun résultat trouvé pour ces filtres.</p>';
        } else {
          container.innerHTML = outputHTML;
        }
        
        lucide.createIcons();
      }
      
      // --- Fonctions CRUD (inchangées) ---

      function showModal(item = null) {
        const isEdit = item !== null;
        crudForm.reset();
        
        if (isEdit) {
          modalTitle.textContent = 'Modifier l''entrée';
          itemIdInput.value = item.id;
          document.getElementById('modal-categorie').value = item.categorie_principale;
          document.getElementById('modal-nom').value = item.nom;
          document.getElementById('modal-details').value = item.details || ''; // Erreur potentielle ici
          document.getElementById('modal-tel').value = item.tel; // Ces champs n'existent pas dans ce modal !
          document.getElementById('modal-email').value = item.email || '';
          document.getElementById('modal-zone').value = item.zone || '';
          document.getElementById('modal-groupe').value = item.groupe;

        } else {
          modalTitle.textContent = 'Ajouter une entrée';
          itemIdInput.value = '';
        }
        modal.style.display = 'flex';
        lucide.createIcons();
      }

      function hideModal() {
        modal.style.display = 'none';
      }

      async function handleFormSubmit(event) {
        event.preventDefault();
        
        const itemId = itemIdInput.value;
        const isEdit = itemId !== '';
        
        // CORRECTION : S'assurer que le modal du répertoire a les bons champs
        const itemData = {
          categorie_principale: document.getElementById('modal-categorie').value,
          nom: document.getElementById('modal-nom').value,
          tel: document.getElementById('modal-tel').value, // Doit exister dans le modal
          email: document.getElementById('modal-email').value || null, // Doit exister
          zone: document.getElementById('modal-zone').value || null, // Doit exister
          groupe: document.getElementById('modal-groupe').value, // Doit exister
          page: null // Ce n'est pas la page pmr/op
        };

        // Supprimer 'page' s'il n'est pas pertinent (c'est le cas ici)
        delete itemData.page;

        let error;
        const submitButton = document.getElementById('modal-submit-button');
        submitButton.disabled = true;
        submitButton.textContent = 'Enregistrement...';

        if (isEdit) {
          const { error: updateError } = await supabaseClient
            .from('contacts_repertoire')
            .update(itemData)
            .eq('id', itemId);
          error = updateError;
        } else {
          const { error: insertError } = await supabaseClient
            .from('contacts_repertoire')
            .insert([itemData]);
          error = insertError;
        }

        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';

        if (error) {
          alert("Erreur: " + error.message);
        } else {
          alert(isEdit ? "Entrée mise à jour !" : "Entrée ajoutée !");
          hideModal();
          updateDisplay();
        }
      }

      async function deleteItem(id, nom) {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer "${nom}" ?`)) {
          return;
        }
        const { error } = await supabaseClient
          .from('contacts_repertoire')
          .delete()
          .eq('id', id);
        if (error) {
          alert("Erreur: " + error.message);
        } else {
          alert("Entrée supprimée !");
          updateDisplay();
        }
      }

      // Lancement initial
      updateDisplay();
      lucide.createIcons(); // Pour l'icône de recherche
    });
  </script>

  <script src="js/layout.js" defer></script>

  <div id="crud-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
    <div class="flex justify-between items-center p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter un contact</h3>
      <button onclick="hideModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <form id="crud-form" onsubmit="handleFormSubmit(event)">
      <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="modal-item-id">
        
        <div class="md:col-span-2">
          <label for="modal-nom" class="block text-sm font-medium text-gray-700">Nom</label>
          <input type="text" id="modal-nom" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-tel" class="block text-sm font-medium text-gray-700">Téléphone</label>
          <input type="text" id="modal-tel" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-email" class="block text-sm font-medium text-gray-700">Email (optionnel)</label>
          <input type="email" id="modal-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div>
          <label for="modal-categorie" class="block text-sm font-medium text-gray-700">Catégorie</label>
          <select id="modal-categorie" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <option value="MIA">MIA</option>
            <option value="RCC-OCC">RCC-OCC</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div>
          <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone (optionnel)</label>
          <input type="text" id="modal-zone" placeholder="FMS, FTY, FCR..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <div class="md:col-span-2">
          <label for="modal-groupe" class="block text-sm font-medium text-gray-700">Groupe</label>
          <input type="text" id="modal-groupe" required placeholder="SPI, CPI, PACO..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      
      <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
        <button type="button" onclick="hideModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
          Annuler
        </button>
        <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

</body>
</html>