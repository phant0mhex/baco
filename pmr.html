<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>PMR - Portail BACO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest" defer></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script> 

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>
<body class="h-full">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Section PMR - État des rampes</h1>
      <button onclick="showPmrModal()" class="admin-only flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
        <i data-lucide="plus" class="w-5 h-5"></i>
        <span>Ajouter une entrée</span>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div>
        <label for="search-bar" class="block text-sm font-medium text-gray-700">Rechercher (Gare, Quai, ID)</label>
        <div class="relative mt-1">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
          </div>
          <input type="search" id="search-bar" oninput="loadPmrData()" placeholder="ATH, 2/3, 2069..." class="block w-full rounded-md border-gray-300 pl-10 px-4 py-2 focus:border-blue-500 focus:ring-blue-500">
        </div>
      </div>
      <div>
        <label for="filter-zone" class="block text-sm font-medium text-gray-700">Filtrer par Zone</label>
        <select id="filter-zone" onchange="loadPmrData()" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500">
          <option value="all">Toutes les zones</option>
          <option value="FTY">FTY</option>
          <option value="FMS">FMS</option>
          <option value="FCR">FCR</option>
        </select>
      </div>
      <div>
        <label for="filter-etat" class="block text-sm font-medium text-gray-700">Filtrer par État</label>
        <select id="filter-etat" onchange="loadPmrData()" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500">
          <option value="all">Tous les états</option>
          <option value="OK">OK</option>
          <option value="HS">HS</option>
          <option value="En attente">En attente</option>
        </select>
      </div>
      <div>
        <label for="filter-type" class="block text-sm font-medium text-gray-700">Filtrer par Type</label>
        <select id="filter-type" onchange="loadPmrData()" class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500">
          <option value="all">Tous les types</option>
          <option value="3h">3h</option>
          <option value="Full">Full</option>
          <option value="Light">Light</option>
          <option value="Taxi">Taxi</option>
        </select>
      </div>
    </div>

    <hr class="my-8">
    <div id="resultDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      </div>
  </div>

  <div id="pmr-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
      <form id="pmr-form" onsubmit="handlePmrFormSubmit(event)">
        <div class="flex justify-between items-center p-4 border-b">
          <h3 id="modal-title" class="text-xl font-semibold text-gray-800">Ajouter une entrée PMR</h3>
          <button type="button" onclick="hidePmrModal()" class="p-1 rounded-full text-gray-500 hover:bg-gray-200">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        
        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto">
          <input type="hidden" id="modal-pmr-id">
          
          <div class="md:col-span-1">
            <label for="modal-gare" class="block text-sm font-medium text-gray-700">Gare (Code)</label>
            <input type="text" id="modal-gare" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="md:col-span-1">
            <label for="modal-quai" class="block text-sm font-medium text-gray-700">Quai</label>
            <input type="text" id="modal-quai" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="md:col-span-1">
            <label for="modal-zone" class="block text-sm font-medium text-gray-700">Zone</label>
            <input type="text" id="modal-zone" placeholder="FTY, FMS, FCR..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>

          <div class="md:col-span-1">
            <label for="modal-type-assistance" class="block text-sm font-medium text-gray-700">Type Assistance</label>
            <select id="modal-type-assistance" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="N/A">N/A</option>
              <option value="3h">3h</option>
              <option value="Full">Full</option>
              <option value="Light">Light</option>
              <option value="Taxi">Taxi</option>
            </select>
          </div>
          <div class="md:col-span-1">
            <label for="modal-type-rampe" class="block text-sm font-medium text-gray-700">Type de rampe</label>
            <input type="text" id="modal-type-rampe" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="md:col-span-1">
            <label for="modal-rampe-id" class="block text-sm font-medium text-gray-700">N° ID Rampe</label>
            <input type="text" id="modal-rampe-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="md:col-span-1">
            <label for="modal-etat-rampe" class="block text-sm font-medium text-gray-700">État Rampe</label>
            <select id="modal-etat-rampe" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option>OK</option>
              <option>HS</option>
              <option>En attente</option>
            </select>
          </div>
          <div class="md:col-span-1">
            <label for="modal-validite" class="block text-sm font-medium text-gray-700">Validité</label>
            <input type="text" id="modal-validite" placeholder="déc-25" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="md:col-span-1">
            <label for="modal-cadenas" class="block text-sm font-medium text-gray-700">Cadenas</label>
            <input type="text" id="modal-cadenas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="md:col-span-3 flex items-end pb-2">
            <label class="flex items-center space-x-2">
              <input type="checkbox" id="modal-reparation" class="rounded text-blue-600 focus:ring-blue-500">
              <span class="font-medium text-gray-700">Réparation demandée</span>
            </label>
          </div>

          <div class="md:col-span-3">
            <label for="modal-remarque-rampe" class="block text-sm font-medium text-gray-700">Remarque Rampe</label>
            <textarea id="modal-remarque-rampe" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div class="md:col-span-3">
            <label for="modal-restrictions-gare" class="block text-sm font-medium text-gray-700">Restrictions Gare</label>
            <textarea id="modal-restrictions-gare" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div class="md:col-span-3">
            <label for="modal-remarque-gare" class="block text-sm font-medium text-gray-700">Remarque Gare</label>
            <textarea id="modal-remarque-gare" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
        </div>
        
        <div class="flex justify-end items-center p-4 bg-gray-50 border-t rounded-b-lg">
          <button type="button" onclick="hidePmrModal()" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none">
            Annuler
          </button>
          <button type="submit" id="modal-submit-button" class="ml-3 px-4 py-2 bg-blue-600 text-white border border-transparent rounded-md shadow-sm hover:bg-blue-700 focus:outline-none">
            Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>


<script src="js/layout.js" defer></script>

<script>
  // Fonctions globales pour les 'onclick'
  let loadPmrData;
  let showPmrModal;
  let hidePmrModal;
  let handlePmrFormSubmit;
  let deletePmrEntry;

  document.addEventListener('DOMContentLoaded', () => {
    
      const notyf = (typeof Notyf !== 'undefined') 
        ? new Notyf({ duration: 3000, position: { x: 'right', y: 'top' }, dismissible: true })
        : { success: (msg) => alert(msg), error: (msg) => alert(msg) }; // Fallback

      const resultDisplay = document.getElementById('resultDisplay');
      const searchInput = document.getElementById('search-bar');
      const zoneFilter = document.getElementById('filter-zone');
      const etatFilter = document.getElementById('filter-etat');
      const typeFilter = document.getElementById('filter-type'); // NOUVEAU
      
      const modal = document.getElementById('pmr-modal');
      const modalTitle = document.getElementById('modal-title');
      const pmrForm = document.getElementById('pmr-form');
      const pmrIdInput = document.getElementById('modal-pmr-id');
      const submitButton = document.getElementById('modal-submit-button');
      
      /**
       * Charge et affiche les données PMR en fonction des filtres
       */
      loadPmrData = async () => {
        resultDisplay.innerHTML = '<div class="col-span-full flex justify-center items-center py-20"><i data-lucide="loader-2" class="w-10 h-10 text-blue-600 animate-spin"></i></div>';
        lucide.createIcons();
        
        try {
          let query = supabaseClient
            .from('pmr_data')
            .select('*')
            .order('gare', { ascending: true }); // Trier par gare A-Z

          // 1. Appliquer les filtres
          const zone = zoneFilter.value;
          const etat = etatFilter.value;
          const type = typeFilter.value; // NOUVEAU
          const searchTerm = searchInput.value.trim();

          if (zone !== 'all') {
            query = query.eq('zone', zone);
          }
          if (etat !== 'all') {
            query = query.eq('etat_rampe', etat);
          }
          if (type !== 'all') { // NOUVEAU
            query = query.eq('type_assistance', type);
          }
          
          // 2. Appliquer la recherche
          if (searchTerm) {
            // 'ilike' est insensible à la casse
            query = query.or(
              `gare.ilike.%${searchTerm}%`,
              `quai.ilike.%${searchTerm}%`,
              `rampe_id.ilike.%${searchTerm}%`
            );
          }
          
          const { data, error } = await query;
          if (error) throw error;

          if (data.length === 0) {
            resultDisplay.innerHTML = '<p class="col-span-full text-gray-600 text-center">Aucun résultat trouvé pour ces filtres.</p>';
            return;
          }

          // 3. Afficher les fiches
          resultDisplay.innerHTML = data.map(entry => renderPmrCard(entry)).join('');
          
          lucide.createIcons();
          if (window.hideAdminElements) window.hideAdminElements();

        } catch (error) {
          resultDisplay.innerHTML = `<p class="col-span-full text-red-600 text-center">Erreur: ${error.message}</p>`;
          notyf.error('Erreur lors du chargement des données.');
        }
      }
      
      /**
       * Génère le HTML pour une seule fiche PMR
       */
      function renderPmrCard(entry) {
        let etatColor = 'text-gray-600 bg-gray-100'; // En attente
        if (entry.etat_rampe === 'OK') {
          etatColor = 'text-green-800 bg-green-100';
        } else if (entry.etat_rampe === 'HS') {
          etatColor = 'text-red-800 bg-red-100';
        }

        // NOUVEAU: Couleur pour le type
        let typeColor = 'bg-gray-100 text-gray-800';
        if (entry.type_assistance === 'Taxi') {
          typeColor = 'bg-yellow-100 text-yellow-800';
        } else if (entry.type_assistance === 'Full') {
          typeColor = 'bg-blue-100 text-blue-800';
        } else if (entry.type_assistance === 'Light') {
          typeColor = 'bg-green-100 text-green-800';
        }

        const entryJson = JSON.stringify(entry).replace(/"/g, "&quot;");
        
        const renderInfo = (icon, label, value) => {
          if (!value) return '';
          return `
            <div class="flex items-start gap-3">
              <i data-lucide="${icon}" class="w-4 h-4 text-gray-500 flex-shrink-0 mt-1"></i>
              <div class="text-sm">
                <span class="font-medium text-gray-600">${label}:</span>
                <span class="text-gray-800">${value}</span>
              </div>
            </div>`;
        };
        
        return `
          <div class="bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col">
            <div class="flex justify-between items-start p-4 border-b">
              <div>
                <h3 class="text-xl font-bold text-blue-700">${entry.gare}</h3>
                <span class="text-sm font-medium text-gray-600">Quai: ${entry.quai || 'N/A'}</span>
              </div>
              <div class="flex flex-col items-end gap-2">
                <span class="px-3 py-1 text-sm font-bold rounded-full ${etatColor}">
                  ${entry.etat_rampe || 'N/A'}
                </span>
                ${entry.type_assistance ? `
                <span class="px-3 py-1 text-xs font-bold rounded-full ${typeColor}">
                  ${entry.type_assistance}
                </span>` : ''}
              </div>
            </div>
            
            <div class="p-4 space-y-3">
              ${renderInfo('combine', 'Type', entry.type_rampe)}
              ${renderInfo('hash', 'ID Rampe', entry.rampe_id)}
              ${renderInfo('shield', 'Zone', entry.zone)}
              ${renderInfo('calendar', 'Validité', entry.validite)}
              ${renderInfo('lock', 'Cadenas', entry.cadenas)}
              ${entry.reparation_demandee ? `<div class="flex items-center gap-2 text-yellow-600"><i data-lucide="wrench" class="w-4 h-4"></i><span class="text-sm font-medium">Réparation demandée</span></div>` : ''}
            </div>
            
            ${(entry.remarque_rampe || entry.restrictions_gare || entry.remarque_gare) ? `
            <div class="p-4 border-t space-y-3">
              ${renderInfo('alert-circle', 'Rem. Rampe', entry.remarque_rampe)}
              ${renderInfo('alert-triangle', 'Restrictions', entry.restrictions_gare)}
              ${renderInfo('info', 'Rem. Gare', entry.remarque_gare)}
            </div>
            ` : ''}

            <div class="admin-only flex justify-end items-center p-3 bg-gray-50 border-t gap-2">
              <button onclick="deletePmrEntry(${entry.id}, '${entry.gare}', '${entry.quai}')" class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-red-600 bg-red-100 rounded hover:bg-red-200">
                <i data-lucide="trash-2" class="w-3 h-3"></i> Supprimer
              </button>
              <button onclick="showPmrModal(${entryJson})" class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-blue-600 bg-blue-100 rounded hover:bg-blue-200">
                <i data-lucide="pencil" class="w-3 h-3"></i> Modifier
              </button>
            </div>
          </div>
        `;
      }
      
      /**
       * Ouvre et pré-remplit le modal
       */
      showPmrModal = (entry = null) => {
        pmrForm.reset();
        const isEdit = entry !== null;
        
        modalTitle.textContent = isEdit ? `Modifier: ${entry.gare} (Quai ${entry.quai})` : 'Ajouter une entrée PMR';
        pmrIdInput.value = isEdit ? entry.id : '';
        
        document.getElementById('modal-gare').value = isEdit ? entry.gare : '';
        document.getElementById('modal-quai').value = isEdit ? entry.quai : '';
        document.getElementById('modal-zone').value = isEdit ? entry.zone : '';
        document.getElementById('modal-type-assistance').value = isEdit ? (entry.type_assistance || 'N/A') : 'N/A'; // NOUVEAU
        document.getElementById('modal-type-rampe').value = isEdit ? (entry.type_rampe || 'Aucune') : 'Aucune';
        document.getElementById('modal-rampe-id').value = isEdit ? entry.rampe_id : '';
        document.getElementById('modal-etat-rampe').value = isEdit ? (entry.etat_rampe || 'OK') : 'OK';
        document.getElementById('modal-validite').value = isEdit ? entry.validite : '';
        document.getElementById('modal-cadenas').value = isEdit ? entry.cadenas : '';
        document.getElementById('modal-reparation').checked = isEdit ? entry.reparation_demandee : false;
        document.getElementById('modal-remarque-rampe').value = isEdit ? entry.remarque_rampe : '';
        document.getElementById('modal-restrictions-gare').value = isEdit ? entry.restrictions_gare : '';
        document.getElementById('modal-remarque-gare').value = isEdit ? entry.remarque_gare : '';
        
        modal.style.display = 'flex';
        lucide.createIcons();
      }
      
      /**
       * Cache le modal
       */
      hidePmrModal = () => {
        modal.style.display = 'none';
      }
      
      /**
       * Gère la soumission du formulaire (Ajout/Modification)
       */
      handlePmrFormSubmit = async (event) => {
        event.preventDefault();
        
        const pmrId = pmrIdInput.value;
        const isEdit = pmrId !== '';
        
        const entryData = {
          gare: document.getElementById('modal-gare').value,
          quai: document.getElementById('modal-quai').value,
          zone: document.getElementById('modal-zone').value,
          type_assistance: document.getElementById('modal-type-assistance').value, // NOUVEAU
          type_rampe: document.getElementById('modal-type-rampe').value,
          rampe_id: document.getElementById('modal-rampe-id').value,
          etat_rampe: document.getElementById('modal-etat-rampe').value,
          validite: document.getElementById('modal-validite').value,
          cadenas: document.getElementById('modal-cadenas').value,
          reparation_demandee: document.getElementById('modal-reparation').checked,
          remarque_rampe: document.getElementById('modal-remarque-rampe').value,
          restrictions_gare: document.getElementById('modal-restrictions-gare').value,
          remarque_gare: document.getElementById('modal-remarque-gare').value,
        };
        
        // Nettoyer les champs vides pour qu'ils soient 'null'
        Object.keys(entryData).forEach(key => {
          if (entryData[key] === '' || entryData[key] === 'N/A') entryData[key] = null;
        });
        
        submitButton.disabled = true;
        submitButton.textContent = 'Enregistrement...';

        try {
          let error;
          if (isEdit) {
            // --- REQUÊTE UPDATE ---
            const { error: updateError } = await supabaseClient
              .from('pmr_data')
              .update(entryData)
              .eq('id', pmrId);
            error = updateError;
          } else {
            // --- REQUÊTE INSERT ---
            const { error: insertError } = await supabaseClient
              .from('pmr_data')
              .insert([entryData]);
            error = insertError;
          }
          if (error) throw error;
          
          notyf.success(isEdit ? "Entrée mise à jour !" : "Entrée ajoutée !");
          hidePmrModal();
          loadPmrData(); // Rafraîchir
          
        } catch (error) {
          notyf.error("Erreur lors de l'opération: " + error.message);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Enregistrer';
        }
      }
      
      /**
       * Supprime une entrée PMR
       */
      deletePmrEntry = async (id, gare, quai) => {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer l'entrée pour ${gare} (Quai ${quai || 'N/A'}) ?`)) {
          return;
        }
        try {
          const { error } = await supabaseClient
            .from('pmr_data')
            .delete()
            .eq('id', id);
          if (error) throw error;
          
          notyf.success("Entrée supprimée !");
          loadPmrData(); // Rafraîchir
        } catch (error) {
           notyf.error("Erreur: " + error.message);
        }
      }
      
      // Lancement initial
      loadPmrData();

  }); // Fin de DOMContentLoaded
</script>

</body>
</html>