<head>
  <meta charset="UTF-8">
  <title>Portail BACO - BUS</title> <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script>

  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'], // Définit Geist Sans comme police par défaut
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>
<body class="h-full">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Filtrer les chauffeurs par ligne</h1>

    <div class="flex flex-wrap gap-3 mb-8" id="ligneCheckboxes">
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.75" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.75</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.75A" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.75A</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.78" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.78</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.90" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.90</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.90C" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.90C</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.94" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.94</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.96" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.96</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.97" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.97</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.108" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.108</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.112" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.112</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.116" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.116</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.117" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.117</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.118" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.118</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.124" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.124</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.130" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.130</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.130A" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.130A</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.132" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.132</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.134" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.134</span>
      </label>
      <label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">
        <input type="checkbox" value="L.140" onchange="updateSocieteDisplay()" class="rounded text-blue-600 focus:ring-blue-500">
        <span class="font-medium text-gray-700">L.140</span>
      </label>
      </div>

    <div class="content" id="content">
      </div>
  </div>


  <script src="js/layout.js" defer></script>
  
  <script>
    // Fini le 'fetch' de bus.json !
    // Le client 'supabaseClient' est déjà disponible depuis 'js/auth.js'

    // Fonction pour afficher les sociétés
    async function updateSocieteDisplay() {
      const lignesSelectionnees = Array.from(document.querySelectorAll('#ligneCheckboxes input:checked'))
        .map(cb => cb.value);

      const container = document.getElementById('content');
      container.innerHTML = ''; // Vider le contenu précédent

      if (lignesSelectionnees.length === 0) {
        container.innerHTML = '<p class="text-gray-600">Veuillez sélectionner au moins une ligne.</p>';
        return;
      }

      // --- NOUVELLE LOGIQUE SUPABASE ---
      
      // 1. Trouver les ID de sociétés qui correspondent aux lignes sélectionnées
      const { data: lignesData, error: lignesError } = await supabaseClient
        .from('lignes_bus')
        .select('societe_id')
        .in('ligne', lignesSelectionnees);

      if (lignesError) {
        container.innerHTML = `<p class='text-red-600'>Erreur Etape 1: ${lignesError.message}</p>`;
        return;
      }

      // Filtrer les ID uniques
      const societeIds = [...new Set(lignesData.map(item => item.societe_id))];

      if (societeIds.length === 0) {
        container.innerHTML = '<p class="text-gray-600">Aucune société trouvée pour les lignes sélectionnées.</p>';
        return;
      }

      // 2. Récupérer les noms de ces sociétés
      const { data: societesAffichees, error: societesError } = await supabaseClient
        .from('societes_bus')
        .select('id, nom')
        .in('id', societeIds);
        
      if (societesError) {
        container.innerHTML = `<p class='text-red-600'>Erreur Etape 2: ${societesError.message}</p>`;
        return;
      }
      // --- FIN DE LA LOGIQUE ---

      // Injection de HTML (similaire à l'ancien, mais on stocke l'ID !)
      container.innerHTML = '<div>' +
          '<h3 class="text-2xl font-semibold text-gray-800 mb-4">Sociétés concernées :</h3>' +
          '<div class="flex flex-wrap gap-3 mb-8" id="societeCheckboxes">' +
            societesAffichees.map(s =>
              `<label class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-full cursor-pointer hover:bg-gray-100 transition-all shadow-sm">` +
                // !! CHANGEMENT IMPORTANT : on utilise s.id dans "value"
                `<input type="checkbox" value="${s.id}" onchange="updateChauffeursDisplay()" class="rounded text-blue-600 focus:ring-blue-500">` +
                `<span class="font-medium text-gray-700">${s.nom}</span></label>`
            ).join('') +
          '</div>' +
         
          '<div id="contact" class="mt-6"></div>' + // Conteneur pour les contacts
          '<div id="chauffeurs" class="mt-6"></div>' + // Conteneur pour les chauffeurs
        '</div>';
    }

    // Fonction pour afficher les chauffeurs
    async function updateChauffeursDisplay() {
      const societesSelectionneesIds = Array.from(document.querySelectorAll('#societeCheckboxes input:checked'))
        .map(cb => cb.value); // Contient maintenant les ID (ex: "1", "3")

      const chauffeursContainer = document.getElementById('chauffeurs');
      const contactsContainer = document.getElementById('contact');

      if (societesSelectionneesIds.length === 0) {
        chauffeursContainer.innerHTML = '';
        contactsContainer.innerHTML = '';
        return;
      }

      // --- NOUVELLE LOGIQUE SUPABASE ---

      // 1. Récupérer les contacts
      // On fait une "jointure" pour récupérer le nom de la société en même temps
      const { data: contactList, error: contactError } = await supabaseClient
        .from('contacts_bus')
        .select(`
          nom,
          tel,
          societes_bus ( nom ) 
        `)
        .in('societe_id', societesSelectionneesIds);

      // 2. Récupérer les chauffeurs
      const { data: chauffeursList, error: chauffeursError } = await supabaseClient
        .from('chauffeurs_bus')
        .select(`
          nom,
          tel,
          societes_bus ( nom )
        `)
        .in('societe_id', societesSelectionneesIds);
      
      // --- FIN DE LA LOGIQUE ---

      if (contactError || chauffeursError) {
        contactsContainer.innerHTML = `<p class='text-red-600'>Erreur chargement contacts: ${contactError?.message || chauffeursError?.message}</p>`;
        return;
      }
      
      // Logique d'affichage (presque identique, mais on accède à 'societes_bus.nom')
      contactsContainer.innerHTML = contactList.length === 0 ? '' :
        '<h3 class="text-2xl font-semibold text-gray-800 mb-4">Contacts de la société :</h3>' +
        '<ul class="space-y-3 list-none p-0 max-w-md">' +
        contactList.map(c => 
          `<li class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">` +
            `<span class="font-semibold text-gray-800">${c.nom} <span class="font-normal text-gray-500">(${c.societes_bus.nom})</span></span>` +
            `<a href="tel:${c.tel}" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors w-full sm:w-auto text-center">${c.tel}</a>` +
          `</li>`
        ).join('') + '</ul>';

      chauffeursContainer.innerHTML = chauffeursList.length === 0 ? '' :
        '<h3 class="text-2xl font-semibold text-gray-800 mb-4">Chauffeurs à contacter :</h3>' +
        '<ul class="space-y-3 list-none p-0 max-w-md">' +
        chauffeursList.map(c => 
          `<li class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 bg-white p-4 rounded-lg border border-gray-200 shadow-sm">` +
            `<span class="font-semibold text-gray-800">${c.nom} <span class="font-normal text-gray-500">(${c.societes_bus.nom})</span></span>` +
            `<a href="tel:${c.tel}" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors w-full sm:w-auto text-center">${c.tel}</a>` +
          `</li>`
        ).join('') + '</ul>';
    }
  </script>
</body>
</html>