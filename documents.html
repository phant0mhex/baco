<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>Documents - Portail BACO</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-sans/variable/geist-sans.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.0.0/dist/fonts/geist-mono/variable/geist-mono.css" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth.js" defer></script> 

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist Sans', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
</head>
<body class="h-full">

  <div id="nav-placeholder"></div>

  <div class="container mx-auto p-8">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <h1 class="text-3xl font-bold text-gray-800">Gestion des Documents</h1>
      
      <label class="admin-only w-full md:w-auto relative flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors cursor-pointer">
        <i data-lucide="upload" class="w-5 h-5"></i>
        <span>Téléverser un document</span>
        <input type="file" id="file-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
      </label>
    </div>

    <div id="upload-status" class="admin-only mb-6 text-sm text-gray-600"></div>

    <div id="documents-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      </div>

  </div>

  <script src="js/layout.js" defer></script>
  
<script>
    document.addEventListener('DOMContentLoaded', () => {
    
      const notyf = (typeof Notyf !== 'undefined') 
        ? new Notyf({ duration: 3000, position: { x: 'right', y: 'top' }, dismissible: true })
        : { success: (msg) => alert(msg), error: (msg) => alert(msg) }; // Fallback

      // ===============================================
      // ==  NOUVEAU : Création du canal Broadcast  ==
      // ===============================================
      const documentsChannel = supabaseClient.channel('baco-documents');
      // -----------------------------------------------

      const documentsList = document.getElementById('documents-list');
      const fileUploadInput = document.getElementById('file-upload');
      const uploadStatus = document.getElementById('upload-status');

      async function loadDocuments() { /* ... (code inchangé) ... */ }

      async function handleUpload(event) {
        // ... (votre logique d'upload)
        try {
          const { error } = await supabaseClient.storage.from('documents').upload(file.name, file, { upsert: true }); 
          if (error) throw error;
          notyf.success(`"${file.name}" a été téléversé.`);
          
          // MODIFIÉ: Envoyer un signal
          documentsChannel.send({ type: 'broadcast', event: 'data-change' });
          loadDocuments(); // Rafraîchir localement aussi

        } catch (error) { /* ... */ } 
        finally { /* ... */ }
      }

      window.deleteDocument = async (fileName) => {
        if (!confirm(`...`)) return;
        try {
          const { error } = await supabaseClient.storage.from('documents').remove([fileName]);
          if (error) throw error;
          notyf.success(`"${fileName}" a été supprimé.`);
          
          // MODIFIÉ: Envoyer un signal
          documentsChannel.send({ type: 'broadcast', event: 'data-change' });
          loadDocuments(); // Rafraîchir localement aussi

        } catch (error) { /* ... */ }
      }
      
      fileUploadInput.addEventListener('change', handleUpload);
      loadDocuments();

      // ===============================================
      // ==  NOUVEAU : SOUSCRIPTION REALTIME BROADCAST  ==
      // ===============================================
      
      documentsChannel
        .on(
          'broadcast', 
          { event: 'data-change' },
          (payload) => {
            console.log('Signal de mise à jour reçu pour les documents!', payload);
            notyf.success('Liste des documents mise à jour...');
            loadDocuments(); // Rafraîchir la vue
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('Connecté au canal temps réel des Documents.');
          }
        });

    }); // Fin de DOMContentLoaded
  </script>

</body>
</html>