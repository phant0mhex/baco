<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>Mon Profil - Portail BACO</title>
      <link rel="icon" type="image/png" href="favicon.jpg">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist&family=Geist+Mono&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lucide@0.303.0/dist/umd/lucide.min.js" defer></script> 
 <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://unpkg.com/notyf@3/notyf.min.css">
  <script src="https://unpkg.com/notyf@3/notyf.min.js"></script>
  
 

  <style>
    /* Style pour l'upload d'avatar */
    .avatar-upload-label { cursor: pointer; position: relative; display: inline-block; width: 128px; height: 128px; }
    .avatar-upload-label:hover .avatar-overlay { opacity: 1; }
    .avatar-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.4); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; border-radius: 9999px; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Geist', 'sans-serif'],
            mono: ['Geist Mono', 'monospace'],
          },
        },
      },
    }
  </script>
  <style>
  /* Cacher le corps par défaut jusqu'à ce que l'auth soit vérifiée */
  body {
    visibility: hidden;
  }
</style>
</head>
<body class="flex flex-col min-h-screen">

  <div id="nav-placeholder"></div>
<div class="flex-grow">
  <div class="container mx-auto p-8 max-w-2xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">
        Mon Profil <span id="admin-badge" class="ml-2"></span>
    </h1>
    
    <div class="bg-white p-6 rounded-lg shadow border border-gray-200 mb-8">
      <form id="profile-form">
        <div class="flex flex-col items-center gap-4 mb-6">
          <label for="avatar-file" class="avatar-upload-label">
            <img id="avatar-preview" src="https://via.placeholder.com/128" alt="Avatar" class="w-32 h-32 rounded-full object-cover border border-gray-300">
            <div class="avatar-overlay">
              <i data-lucide="camera" class="w-8 h-8"></i>
            </div>
          </label>
          <input type="file" id="avatar-file" class="hidden" accept="image/png, image/jpeg">
          <span id="avatar-upload-status" class="text-sm text-gray-500"></span>
        </div>

        <div class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="email" disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
          </div>
          <div>
            <label for="role" class="block text-sm font-medium text-gray-700">Rôle</label>
            <input type="text" id="role" disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed">
          </div>
          <div>
            <label for="username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
            <input type="text" id="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="full_name" class="block text-sm font-medium text-gray-700">Nom complet</label>
            <input type="text" id="full_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          
          <div class="flex justify-end pt-4">
            <button type="submit" id="save-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
              Enregistrer les modifications
            </button>
          </div>
        </div>
      </form>
    </div>


<div class="bg-white p-6 rounded-lg shadow border border-gray-200 mb-8">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Mon Casier d'Infractions</h2>

  <div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 mb-2">Niveau de Confiance</label>
    <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden shadow-inner">
      <div id="ban-meter-fill" 
           class="h-5 rounded-full text-right text-xs text-white font-bold pr-2 transition-all duration-1000 ease-out"
           style="width: 100%;"
           >
           </div>
    </div>
    <p class="text-xs text-gray-500 mt-1 text-center" id="ban-meter-status">Chargement...</p>
  </div>

  <h3 class="text-lg font-medium text-gray-800 mb-3">Historique des cartons :</h3>
  <div id="infractions-list" class="space-y-3 max-h-60 overflow-y-auto pr-2">
    <p class="text-gray-500 text-sm">Chargement de votre historique...</p>
  </div>
</div>


    <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Sécurité</h2>
      <form id="password-form" class="space-y-4">
        <div>
          <label for="new-password" class="block text-sm font-medium text-gray-700">Nouveau mot de passe</label>
          <input type="password" id="new-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmer le mot de passe</label>
          <input type="password" id="confirm-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="flex justify-end pt-4">
            <button type="submit" id="password-save-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors">
              Changer le mot de passe
            </button>
          </div>
      </form>
    </div>

  </div>

<script src="js/core/layout.js" type="module"></script>
  
  <script>
   window.pageInit = () => {
    
      // 1. INITIALISER NOTYF
      if (typeof Notyf === 'undefined') {
        console.error("Notyf n'est pas chargé !");
        window.notyf = { success: (msg) => alert(msg), error: (msg) => alert(msg) };
      } else {
        window.notyf = new Notyf({
          duration: 3000,
          position: { x: 'right', y: 'top' },
          dismissible: true
        });
      }

      // 2. RÉCUPÉRER LES ÉLÉMENTS DU DOM
      
      // Formulaire de profil
      const profileForm = document.getElementById('profile-form');
      const saveButton = document.getElementById('save-button');
      const emailInput = document.getElementById('email');
      const roleInput = document.getElementById('role');
      const usernameInput = document.getElementById('username');
      const fullNameInput = document.getElementById('full_name');
      const avatarPreview = document.getElementById('avatar-preview');
      const avatarFileInput = document.getElementById('avatar-file');
      const avatarStatus = document.getElementById('avatar-upload-status');
      
      // NOUVEAU: Formulaire de mot de passe
      const passwordForm = document.getElementById('password-form');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-password');
      const passwordSaveButton = document.getElementById('password-save-button');

      const banMeterFill = document.getElementById('ban-meter-fill');
const banMeterStatus = document.getElementById('ban-meter-status');
const infractionsList = document.getElementById('infractions-list');
      
      let currentUserId = null;
      let uploading = false;

      // 3. DÉFINIR LES FONCTIONS
      
      // --- Fonctions de profil (mise à jour) ---
      
      async function getProfile() {
        try {
          const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
          if (authError || !user) throw authError || new Error('Utilisateur non trouvé');
          currentUserId = user.id;
          emailInput.value = user.email;
          loadInfractions(currentUserId);
          const { data, error, status } = await supabaseClient.from('profiles').select(`username, full_name, avatar_url`).eq('id', user.id).single();
          if (error && status !== 406) throw error;
          if (data) {
            usernameInput.value = data.username || '';
            fullNameInput.value = data.full_name || '';
            if (data.avatar_url) avatarPreview.src = data.avatar_url + `?t=${new Date().getTime()}`;
          }


// --- Logique pour le rôle ---
      const userRole = sessionStorage.getItem('userRole'); // Récupère le rôle
      if (roleInput && userRole) {
          // Met en majuscule la première lettre (ex: "admin" -> "Admin")
          roleInput.value = userRole.charAt(0).toUpperCase() + userRole.slice(1);
      }
      // --- Fin de la logique ---

        // Votre logique existante pour le badge admin peut rester
      const badgeSpan = document.getElementById('admin-badge');
      if (userRole === 'admin' && badgeSpan) {
              badgeSpan.innerHTML = `
                  <span title="Administrateur Certifié" 
                        class="inline-flex items-center gap-1.5 px-3 py-1 
                               bg-blue-600 text-white text-sm font-semibold rounded-full shadow-md">
                      <i data-lucide="shield-check" class="w-4 h-4"></i>
                      Admin
                  </span>
              `;
              // Redessiner Lucide pour que l'icône s'affiche
              if (typeof lucide !== 'undefined') lucide.createIcons(); 
          }
          // ------------------------------------------

        } catch (error) {
          console.error("Erreur chargement profil:", error.message);
          window.notyf.error("Impossible de charger le profil : " + error.message);
        }
      }

      async function updateProfile() {
        try {
          saveButton.disabled = true;
          saveButton.textContent = 'Enregistrement...';
          const updates = { id: currentUserId, username: usernameInput.value, full_name: fullNameInput.value, updated_at: new Date() };
          const { error } = await supabaseClient.from('profiles').upsert(updates);
          if (error) throw error;
          window.notyf.success('Profil mis à jour !');
        } catch (error) {
          window.notyf.error('Erreur mise à jour profil : ' + error.message);
        } finally {
          saveButton.disabled = false;
          saveButton.textContent = 'Enregistrer les modifications';
        }
      }
      
      async function handleAvatarUpload(event) {
        if (uploading || !currentUserId) return;
        const file = event.target.files[0];
        if (!file) return;
        uploading = true;
        avatarStatus.textContent = 'Téléchargement...';
        try {
          const fileExt = file.name.split('.').pop();
          const fileName = `${Math.random()}.${fileExt}`;
          const filePath = `${currentUserId}/${fileName}`;
          const { error: uploadError } = await supabaseClient.storage.from('avatars').upload(filePath, file, { upsert: true });
          if (uploadError) throw uploadError;
          const { data: urlData } = supabaseClient.storage.from('avatars').getPublicUrl(filePath);
          if (!urlData) throw new Error("Impossible d'obtenir l'URL publique.");
          const publicURL = urlData.publicUrl;
          const { error: updateError } = await supabaseClient.from('profiles').update({ avatar_url: publicURL, updated_at: new Date() }).eq('id', currentUserId);
          if (updateError) throw updateError;
          avatarPreview.src = publicURL + `?t=${new Date().getTime()}`;
          avatarStatus.textContent = '';
          window.notyf.success('Avatar mis à jour !');
        } catch (error) {
          console.error("Erreur upload avatar:", error.message);
          avatarStatus.textContent = '';
          window.notyf.error("Échec de l'upload.");
        } finally {
          uploading = false;
        }
      }


    // --- NOUVELLE FONCTION UTILITAIRE ---

function renderCardRow(card) {
        const icon = card.card_type === 'yellow' ? 'file-warning' : 'file-alert';
        const color = card.card_type === 'yellow' ? 'text-yellow-600' : 'text-red-600';
       const adminName = 'un administrateur';
        const date = new Date(card.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });

        // On n'affiche plus de statut, car seuls les actifs sont montrés
        return `
        <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border">
          <i data-lucide="${icon}" class="w-5 h-5 ${color} flex-shrink-0 mt-0.5"></i>
          <div class="flex-grow">
            <p class="font-medium text-gray-800">
              Carton ${card.card_type === 'yellow' ? 'Jaune' : 'Rouge'}
            </p>
            <p class="text-sm text-gray-600 italic">"${card.reason || 'Aucune raison spécifiée'}"</p>
            <p class="text-xs text-gray-500 mt-1">Donné par ${adminName} le ${date}</p>
          </div>
          </div>
        `;
    }


async function loadInfractions(userId) {
        if (!userId) return;

        try {
            // --- DÉBUT DE LA CORRECTION ---
            // Tous les filtres sont maintenant chaînés en une seule requête.
            const { data, error } = await supabaseClient
                .from('infractions')
                .select('*') // On ne fait pas la jointure vers les admins
                .eq('user_id', userId) // Filtre 1: Pour cet utilisateur
                .eq('is_active', true) // Filtre 2: Qui sont actifs
                .or(
                    'card_type.eq.red, and(card_type.eq.yellow,expires_at.gt.now())'
                ) // Filtre 3: Et qui sont (un Rouge) OU (un Jaune non-expiré)
                .order('created_at', { ascending: false });
            // --- FIN DE LA CORRECTION ---

            if (error) throw error;

            if (data.length === 0) {
                banMeterFill.style.width = '100%';
                banMeterFill.className = 'h-5 rounded-full text-right text-xs text-white font-bold pr-2 transition-all duration-1000 ease-out bg-gradient-to-r from-green-400 to-green-600';
                banMeterStatus.textContent = "Votre dossier est impeccable !";
                infractionsList.innerHTML = '<p class="text-gray-500 text-sm">Aucune infraction active enregistrée.</p>';
                return;
            }

            let yellowPoints = 0;
            let redPoints = 0;
            const maxPoints = 6; 

            infractionsList.innerHTML = ''; 

            data.forEach(card => {
                infractionsList.innerHTML += renderCardRow(card);
                if (card.card_type === 'yellow') yellowPoints += 1;
                if (card.card_type === 'red') redPoints += 1;
            });
            
            lucide.createIcons();

            // (Le reste de la fonction est inchangé et gère le "Ban Meter")
            const totalPoints = (redPoints * maxPoints) + yellowPoints;
            let percentage = 100 - ((totalPoints / maxPoints) * 100);
            if (percentage < 0) percentage = 0;
            setTimeout(() => { banMeterFill.style.width = `${percentage}%`; }, 100);
            if (totalPoints === 0) {
                 banMeterFill.className = 'h-5 rounded-full text-right text-xs text-white font-bold pr-2 transition-all duration-1000 ease-out bg-gradient-to-r from-green-400 to-green-600';
                 banMeterStatus.textContent = "Niveau de confiance excellent (compteur à zéro).";
            } else if (totalPoints < 3) { 
                banMeterFill.className = 'h-5 rounded-full text-right text-xs text-black font-bold pr-2 transition-all duration-1000 ease-out bg-gradient-to-r from-yellow-300 to-yellow-400';
                banMeterStatus.textContent = "Niveau de confiance moyen. Attention.";
            } else if (totalPoints < 6) { 
                 banMeterFill.className = 'h-5 rounded-full text-right text-xs text-white font-bold pr-2 transition-all duration-1000 ease-out bg-gradient-to-r from-orange-500 to-orange-600';
                 banMeterStatus.textContent = "Niveau de confiance bas. Ban temporaire actif.";
            } else { 
                banMeterFill.className = 'h-5 rounded-full text-right text-xs text-white font-bold pr-2 transition-all duration-1000 ease-out bg-gradient-to-r from-red-600 to-red-700';
                banMeterStatus.textContent = "Niveau de confiance critique. Compte banni.";
            }
            banMeterFill.textContent = `${Math.round(percentage)}%`;

        } catch (error) {
            infractionsList.innerHTML = `<p class="text-red-500 text-sm">Erreur: ${error.message}</p>`;
        }
    }

      // --- NOUVELLE FONCTION: Changer le mot de passe ---
      async function updatePassword(event) {
        event.preventDefault();
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        // Vérification simple côté client
        if (newPassword.length < 6) {
          window.notyf.error('Le mot de passe doit faire au moins 6 caractères.');
          return;
        }
        if (newPassword !== confirmPassword) {
          window.notyf.error('Les mots de passe ne correspondent pas.');
          return;
        }

        passwordSaveButton.disabled = true;
        passwordSaveButton.textContent = 'Enregistrement...';

        try {
          // Appel à Supabase Auth pour mettre à jour l'utilisateur
          const { error } = await supabaseClient.auth.updateUser({
            password: newPassword
          });
          
          if (error) throw error;
          
          window.notyf.success('Mot de passe mis à jour avec succès !');
          passwordForm.reset(); // Vider les champs

        } catch (error) {
          console.error("Erreur mise à jour MDP:", error.message);
          window.notyf.error('Erreur: ' + error.message);
        } finally {
          passwordSaveButton.disabled = false;
          passwordSaveButton.textContent = 'Changer le mot de passe';
        }
      }

      // 4. LANCER LE CODE
      
      getProfile();
      
      // Attacher les écouteurs d'événements
      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        updateProfile();
      });
      avatarFileInput.addEventListener('change', handleAvatarUpload);
      
      // NOUVEAU: Écouteur pour le formulaire de mot de passe
      passwordForm.addEventListener('submit', updatePassword);

    };
  </script>
<div id="footer-placeholder"></div>
</div>
</body>
</html>